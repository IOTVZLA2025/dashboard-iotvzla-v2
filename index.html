
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="apple-touch-icon" href="logo-millares.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#020612 0%, #071427 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
  }

  /* HEADER FIJADO */
  .main-header{
    padding:12px 15px;
    background:rgba(11, 18, 32, 0.95);
    border-bottom:1px solid rgba(255,255,255,0.04);
    position:sticky;
    top:0;
    z-index:100;
    backdrop-filter:blur(5px);
  }
  .header-content{
    display:flex;
    align-items:center;
    gap:12px;
    max-width:900px;
    margin:0 auto;
  }
  .logo-img{
    width:42px;
    height:42px;
    border-radius:8px;
    object-fit:contain;
    background:rgba(255,255,255,0.05);
    padding:4px;
    border:1px solid rgba(0,188,212,0.2);
  }
  .header-text{
    flex:1;
  }
  .header-text h1{
    margin:0;
    font-size:17px;
    color:#fff;
    letter-spacing:0.5px;
  }
  .company-name{
    font-size:13px;
    color:#00bcd4;
    font-weight:600;
    margin-top:2px;
  }
  .header-subtitle{
    font-size:11px;
    color:var(--muted);
    margin-top:1px;
  }

  /* CONTENIDO PRINCIPAL */
  .main-container{
    max-width:900px;
    margin:0 auto;
    padding:15px;
  }

  /* GAUGE PRINCIPAL */
  .gauge-section{
    background:var(--card);
    border-radius:12px;
    padding:20px 15px;
    margin-bottom:15px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 8px 25px rgba(2,6,23,0.5);
  }

  /* CONTENEDOR GAUGE */
  .gauge-container{
    position:relative;
    width:280px;
    height:140px;
    margin:0 auto 15px auto;
  }

  /* FONDO DEL GAUGE */
  .gauge-background{
    position:absolute;
    width:280px;
    height:140px;
    background:#0a1525;
    border-radius:0 0 140px 140px;
    border:6px solid rgba(255,255,255,0.05);
    border-top:none;
    box-shadow:inset 0 8px 15px rgba(0,0,0,0.6),
               0 4px 12px rgba(0,0,0,0.3);
    overflow:hidden;
  }

  /* ARCO DE COLORES */
  .gauge-arc{
    position:absolute;
    width:280px;
    height:140px;
    background:conic-gradient(
      from 180deg,
      #00c853 0deg,      /* -15°C verde */
      #ffca28 90deg,     /* 30°C amarillo */
      #ff9800 135deg,    /* 60°C naranja */
      #ff1744 180deg     /* 100°C rojo */
    );
    border-radius:0 0 140px 140px;
    clip-path:polygon(0% 70%, 100% 70%, 100% 100%, 0% 100%);
    opacity:0.35;
  }

  /* MARCAS EN FORMA DE U INVERTIDA */
  .gauge-marks{
    position:absolute;
    width:100%;
    height:100%;
  }
  .gauge-mark{
    position:absolute;
    width:3px;
    height:15px;
    background:#fff;
    transform-origin:50% 140px;
    left:calc(50% - 1.5px);
    top:0;
    box-shadow:0 0 4px rgba(255,255,255,0.5);
    z-index:5;
  }

  /* NÚMEROS EN FORMA DE U INVERTIDA */
  .gauge-numbers{
    position:absolute;
    width:100%;
    height:100%;
    color:#fff;
    font-size:14px;
    font-weight:600;
    text-shadow:0 1px 3px rgba(0,0,0,0.8);
  }
  .gauge-number{
    position:absolute;
    text-align:center;
    width:24px;
    margin-left:-12px;
    z-index:6;
  }

  /* AGUJA EN CENTRO CORRECTO */
  .gauge-needle{
    --rot:0deg;
    position:absolute;
    width:2px;
    height:90px;
    background:linear-gradient(to top, #ffca28, #ff9800);
    border-radius:1px;
    transform-origin:50% 140px;
    left:calc(50% - 1px);
    top:0;
    transform:rotate(var(--rot));
    z-index:20;
    box-shadow:0 0 6px rgba(255,202,40,0.6);
  }

  /* CENTRO DE LA AGUJA */
  .needle-center{
    position:absolute;
    width:14px;
    height:14px;
    background:#000;
    border:2px solid #ffca28;
    border-radius:50%;
    left:calc(50% - 7px);
    top:calc(140px - 7px);
    z-index:21;
    box-shadow:0 0 6px rgba(255,202,40,0.4);
  }

  /* TEMPERATURA DIGITAL */
  .temp-display{
    text-align:center;
    margin-top:10px;
  }
  .temp-value{
    font-size:42px;
    font-weight:800;
    color:#ffca28;
    text-shadow:0 3px 10px rgba(255,202,40,0.3);
    line-height:1;
    margin-bottom:5px;
  }
  .temp-unit{
    font-size:22px;
    color:rgba(255,255,255,0.7);
    margin-left:2px;
  }

  /* INFO DEL GAUGE */
  .gauge-info{
    text-align:center;
    margin-top:15px;
  }
  .update-time{
    font-size:13px;
    color:var(--muted);
    margin:8px 0;
    padding:6px 12px;
    background:rgba(255,255,255,0.02);
    border-radius:6px;
    display:inline-block;
  }
  .update-note{
    font-size:12px;
    color:var(--muted);
  }

  /* PANEL DE ESTADOS */
  .status-panel{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-top:20px;
  }

  /* TARJETAS DE ESTADO */
  .status-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
    border-radius:10px;
    padding:12px;
    border:1px solid rgba(255,255,255,0.03);
    text-align:center;
  }
  .status-title{
    font-weight:700;
    font-size:14px;
    margin-bottom:8px;
    color:#fff;
  }
  .status-value{
    font-size:12px;
    color:var(--muted);
    margin-bottom:10px;
    min-height:18px;
  }

  /* LEDS */
  .status-led{
    width:60px;
    height:60px;
    border-radius:10px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:16px;
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }
  .led-green{
    background:linear-gradient(180deg,var(--ok),#007a2b);
    color:#021;
  }
  .led-red{
    background:linear-gradient(180deg,var(--danger),#a1002b);
    color:#250005;
  }
  .led-yellow{
    background:linear-gradient(180deg,var(--yellow),#b37a00);
    color:#2b1a00;
  }
  .led-off{
    background:rgba(255,255,255,0.02);
    color:var(--muted);
  }

  /* INFO DE CONEXIÓN */
  .connection-info{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:var(--muted);
    margin-top:20px;
    padding-top:12px;
    border-top:1px solid rgba(255,255,255,0.03);
  }

  /* BANNERS */
  .alert-banner{
    padding:10px;
    border-radius:8px;
    text-align:center;
    font-weight:700;
    font-size:14px;
    margin-top:15px;
    display:none;
  }
  .alert-alarm{
    background:linear-gradient(90deg,#311000,#6b0000);
    color:#fff;
  }
  .alert-reset{
    background:linear-gradient(90deg,#352e0b, #7a5d00);
    color:#fff;
  }

  /* FOOTER */
  .main-footer{
    text-align:center;
    font-size:11px;
    color:var(--muted);
    margin-top:20px;
    padding-top:15px;
    border-top:1px solid rgba(255,255,255,0.03);
  }

  /* RESPONSIVE */
  @media(max-width:620px){
    .main-container{
      padding:10px;
    }
    .gauge-container{
      width:260px;
      height:130px;
    }
    .gauge-background,
    .gauge-arc{
      width:260px;
      height:130px;
      border-radius:0 0 130px 130px;
    }
    .gauge-needle{
      height:85px;
      transform-origin:50% 130px;
    }
    .needle-center{
      top:calc(130px - 7px);
    }
    .gauge-mark{
      transform-origin:50% 130px;
    }
    .temp-value{
      font-size:38px;
    }
    .status-panel{
      grid-template-columns:1fr;
      gap:10px;
    }
    .header-content{
      flex-direction:column;
      text-align:center;
      gap:8px;
    }
    .logo-img{
      width:36px;
      height:36px;
    }
  }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="main-header">
    <div class="header-content">
      <img src="logo-millares.png" alt="Logo Millares" class="logo-img">
      <div class="header-text">
        <h1>MONITOREO VARIABLES</h1>
        <div class="company-name">MILLARES BAGB SPA IOT CHILE</div>
        <div class="header-subtitle">Temperatura · Alarma · Reset</div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-container">
    <!-- GAUGE -->
    <section class="gauge-section">
      <div class="gauge-container">
        <div class="gauge-background"></div>
        <div class="gauge-arc"></div>
        <div class="gauge-marks" id="gauge-marks"></div>
        <div class="gauge-numbers" id="gauge-numbers"></div>
        <div class="gauge-needle" id="needle" style="--rot:0deg"></div>
        <div class="needle-center"></div>
      </div>

      <div class="temp-display">
        <div class="temp-value" id="temp-digital">25.3<span class="temp-unit">°C</span></div>
      </div>

      <div class="gauge-info">
        <div id="update-time" class="update-time">Última actualización: --</div>
        <div class="update-note">Actualización automática cada 30 segundos</div>
      </div>

      <!-- PANEL DE ESTADOS -->
      <div class="status-panel">
        <div class="status-card">
          <div class="status-title">Estado alarma</div>
          <div id="alarma-text" class="status-value">Normal</div>
          <div id="led-alarma" class="status-led led-green">✓</div>
        </div>

        <div class="status-card">
          <div class="status-title">Reset sistema</div>
          <div id="reset-text" class="status-value">No activo</div>
          <div id="led-reset" class="status-led led-off">-</div>
        </div>
      </div>

      <!-- BANNERS -->
      <div id="alarm-banner" class="alert-banner alert-alarm">ALARMA ACTIVADA</div>
      <div id="reset-banner" class="alert-banner alert-reset">RESET RECOMENDADO</div>

      <!-- INFO CONEXIÓN -->
      <div class="connection-info">
        <div id="last-ping">Último ping: --</div>
        <div id="conn-status">Conexión: --</div>
      </div>
    </section>

    <footer class="main-footer">
      &copy; 2024 MILLARES BAGB SPA IOT CHILE - Sistema IoT
    </footer>
  </main>

<script>
// =============================================
// CONFIGURACIÓN THINGSPEAK
// =============================================
const CONFIG = {
  thingspeak: {
    channelId: '3194050',
    readApiKey: '4L6L63LNFO0YG4BB',
    field: 1,
    url: 'https://api.thingspeak.com/channels/'
  },
  updateInterval: 30000,
  alarmThreshold: 50,
  resetThreshold: 60
};

// =============================================
// INICIALIZAR GAUGE - MARCAS EN FORMA DE U INVERTIDA
// =============================================
function initGauge() {
  const marksContainer = document.getElementById('gauge-marks');
  const numbersContainer = document.getElementById('gauge-numbers');
  
  const minTemp = -15;
  const maxTemp = 100;
  const range = maxTemp - minTemp;
  
  // Ángulo CORREGIDO para U invertida
  // -15°C = 180° (extremo izquierdo del arco)
  // 100°C = 0° (extremo derecho del arco)
  const startAngle = 180;  // Izquierda
  const endAngle = 0;      // Derecha
  const angleRange = 180;  // 180 grados de arco
  
  // Números que queremos mostrar
  const numbers = [-15, 0, 25, 50, 75, 100];
  
  // Crear una marca y número para cada valor
  numbers.forEach(temp => {
    const percent = (temp - minTemp) / range;
    
    // Calcular ángulo CORREGIDO para U invertida
    // Los ángulos van de 180° (izquierda) a 0° (derecha)
    const angle = startAngle - (percent * angleRange);
    
    // Crear MARCA (raya)
    const mark = document.createElement('div');
    mark.className = 'gauge-mark';
    mark.style.transform = `rotate(${angle}deg)`;
    marksContainer.appendChild(mark);
    
    // Crear NÚMERO
    const number = document.createElement('div');
    number.className = 'gauge-number';
    number.textContent = temp;
    
    // Posicionar número ARRIBA de la marca
    const rad = angle * (Math.PI / 180);
    const radius = 100; // Radio para números
    const centerX = 140; // Centro horizontal
    const centerY = 140; // Centro vertical
    
    // Calcular posición X,Y sobre el arco
    const x = centerX + Math.cos(rad) * radius;
    const y = centerY - Math.sin(rad) * radius;
    
    number.style.left = `${x}px`;
    number.style.top = `${y}px`;
    
    // Rotar números para que sigan la curva del arco
    let textRotation = 0;
    if (angle > 90 && angle <= 180) {
      // Lado izquierdo: rotar para que queden horizontales
      textRotation = angle - 180;
    } else if (angle >= 0 && angle <= 90) {
      // Lado derecho: rotar para que queden horizontales
      textRotation = angle;
    }
    
    number.style.transform = `translateX(-50%) rotate(${textRotation}deg)`;
    
    numbersContainer.appendChild(number);
  });
}

// =============================================
// OBTENER DATOS DE THINGSPEAK
// =============================================
async function fetchThingSpeakData() {
  const { channelId, readApiKey, field, url } = CONFIG.thingspeak;
  const apiUrl = `${url}${channelId}/fields/${field}/last.json?api_key=${readApiKey}`;
  
  try {
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error('Error en la respuesta');
    const data = await response.json();
    return parseFloat(data[`field${field}`]) || 0;
  } catch (error) {
    console.error('Error conectando a ThingSpeak:', error);
    return 25.3;
  }
}

// =============================================
// ACTUALIZAR GAUGE - CALIBRACIÓN CORRECTA
// =============================================
function updateGauge(temp) {
  const needle = document.getElementById('needle');
  const tempDigital = document.getElementById('temp-digital');
  
  tempDigital.textContent = temp.toFixed(1);
  
  const minTemp = -15;
  const maxTemp = 100;
  const clampedTemp = Math.max(minTemp, Math.min(maxTemp, temp));
  const percent = (clampedTemp - minTemp) / (maxTemp - minTemp);
  
  // Calcular ángulo CORREGIDO para U invertida
  // -15°C = 180° (izquierda), 100°C = 0° (derecha)
  const angle = 180 - (percent * 180);
  
  needle.style.setProperty('--rot', `${angle}deg`);
  
  // Color según temperatura
  if (temp >= 20 && temp <= 30) {
    tempDigital.style.color = '#00c853';
  } else if (temp > 30 && temp <= 50) {
    tempDigital.style.color = '#ffca28';
  } else if (temp > 50 && temp <= CONFIG.alarmThreshold) {
    tempDigital.style.color = '#ff9800';
  } else if (temp > CONFIG.alarmThreshold) {
    tempDigital.style.color = '#ff1744';
  } else if (temp < 0) {
    tempDigital.style.color = '#00bcd4';
  } else {
    tempDigital.style.color = '#ffca28';
  }
  
  return temp;
}

// =============================================
// ACTUALIZAR ESTADOS
// =============================================
function updateStatus(temp) {
  const alarmLed = document.getElementById('led-alarma');
  const alarmText = document.getElementById('alarma-text');
  const resetLed = document.getElementById('led-reset');
  const resetText = document.getElementById('reset-text');
  const alarmBanner = document.getElementById('alarm-banner');
  const resetBanner = document.getElementById('reset-banner');
  
  if (temp > CONFIG.alarmThreshold) {
    alarmLed.className = 'status-led led-red';
    alarmLed.textContent = '!';
    alarmText.textContent = 'ALARMA';
    alarmText.style.color = '#ff1744';
    alarmBanner.style.display = 'block';
  } else if (temp > 30) {
    alarmLed.className = 'status-led led-yellow';
    alarmLed.textContent = '⚠';
    alarmText.textContent = 'ADVERTENCIA';
    alarmText.style.color = '#ffca28';
    alarmBanner.style.display = 'none';
  } else {
    alarmLed.className = 'status-led led-green';
    alarmLed.textContent = '✓';
    alarmText.textContent = 'Normal';
    alarmText.style.color = '';
    alarmBanner.style.display = 'none';
  }
  
  if (temp > CONFIG.resetThreshold) {
    resetLed.className = 'status-led led-red';
    resetLed.textContent = '!';
    resetText.textContent = 'RESET RECOMENDADO';
    resetText.style.color = '#ff1744';
    resetBanner.style.display = 'block';
  } else {
    resetLed.className = 'status-led led-off';
    resetLed.textContent = '-';
    resetText.textContent = 'No activo';
    resetText.style.color = '';
    resetBanner.style.display = 'none';
  }
}

// =============================================
// ACTUALIZAR TIMESTAMP
// =============================================
function updateTimestamp(success = true) {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('es-CL', { 
    hour: '2-digit', 
    minute: '2-digit',
    second: '2-digit' 
  });
  const dateStr = now.toLocaleDateString('es-CL');
  
  document.getElementById('update-time').textContent = `Última actualización: ${dateStr} ${timeStr}`;
  document.getElementById('last-ping').textContent = `Ping: ${timeStr}`;
  
  const statusEl = document.getElementById('conn-status');
  if (success) {
    statusEl.textContent = 'Conexión: OK';
    statusEl.style.color = '#00c853';
  } else {
    statusEl.textContent = 'Conexión: ERROR';
    statusEl.style.color = '#ff1744';
  }
}

// =============================================
// FUNCIÓN PRINCIPAL
// =============================================
async function updateDashboard() {
  try {
    const temperature = await fetchThingSpeakData();
    updateGauge(temperature);
    updateStatus(temperature);
    updateTimestamp(true);
  } catch (error) {
    updateTimestamp(false);
  }
}

// =============================================
// INICIALIZAR
// =============================================
document.addEventListener('DOMContentLoaded', function() {
  initGauge();
  updateDashboard();
  setInterval(updateDashboard, CONFIG.updateInterval);
});
</script>
</body>
</html>
