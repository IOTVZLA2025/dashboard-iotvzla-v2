
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --green:#00c853;
    --yellow:#ffca28;
    --orange:#ff9800;
    --red:#ff1744;
    --blue:#29b6f6;
    --frame:#0d1a2e;
  }

  body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:white;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    padding:15px;
  }

  .page-frame {
    background: var(--frame);
    border-radius: 20px;
    border: 2px solid rgba(0, 188, 212, 0.3);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    max-width: 1000px;
    width: 100%;
    margin: 0 auto;
    overflow: hidden;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .header{
    padding:15px 20px;
    background:linear-gradient(135deg, #0b1220, #071a33);
    border-bottom:1px solid rgba(0,188,212,0.2);
  }
  .header-content{
    display:flex;
    gap:12px;
    align-items:center;
    max-width:900px;
    margin:0 auto;
  }
  
  /* LOGO MEJORADO PARA 255×164px - SE AJUSTA A 45×45px SIN DEFORMAR */
  .header-logo{
    width:45px;
    height:45px;
    border-radius:10px;
    background:rgba(255,255,255,0.05);
    padding:3px; /* Reducido para mejor ajuste */
    border:1px solid var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden; /* Oculta lo que sobresalga */
  }
  
  .header-logo img{
    max-width:100%;
    max-height:100%;
    width:auto;
    height:auto;
    object-fit:contain; /* Mantiene proporción sin recortar */
  }
  
  .header-text h1{
    font-size:17px;
    margin:0;
    color:white;
  }
  .header-company{
    color:var(--accent);
    font-size:14px;
    font-weight:600;
  }
  .header-subtitle{
    font-size:12px;
    color:var(--muted);
  }

  /* ... (el resto del CSS permanece igual) ... */

</style>
</head>

<body>

<div class="page-frame">

  <header class="header">
    <div class="header-content">
      <!-- LOGO MODIFICADO - CON CONTENEDOR PARA MEJOR AJUSTE -->
      <div class="header-logo">
        <img src="logo-millares.png" alt="Logo Millares">
      </div>
      <div class="header-text">
        <h1>MONITOREO DE VARIABLES</h1>
        <div class="header-company">MILLARES INGENIERIA BAGB SPA IOT-CHILE</div>
        <div class="header-subtitle">Temperatura · Alarma · Reset</div>
      </div>
    </div>
  </header>

  <div class="container">

    <div class="thermo-card">
      <div class="thermo-wrap">

        <div class="thermo-bar">
          <div id="mercury" class="thermo-mercury"></div>
        </div>

        <div class="thermo-scale">
          <span>-15</span><span>0</span><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span>
        </div>

        <div class="temp-digital">
          <span id="tempValue">0.0</span>°C
        </div>

        <div id="updateTime" class="update-time">
          Última medición: --/--/---- --:--:-- --
        </div>

        <div class="leds-container">
          
          <div class="led-bulb">
            <div id="bulbAlarm" class="bulb-circle bulb-green">✓</div>
            <div class="bulb-label">ALARMA</div>
            <div id="alarmText" class="bulb-status">Normal</div>
          </div>

          <div class="led-bulb">
            <div id="bulbReset" class="bulb-circle bulb-off">-</div>
            <div class="bulb-label">RESET</div>
            <div id="resetText" class="bulb-status">No activo</div>
          </div>

        </div>

      </div>
    </div>

    <div class="footer-copy">
      &copy; MILLARES INGENIERIA SPA CHILE
    </div>

  </div>

</div>

<script>
const CONFIG = {
  channelId: "3194050",
  apiKey: "4L6L63LNFO0YG4BB",
  alarm: 50,
  reset: 60
};

// Variables para guardar el último estado REAL
let lastRealTemp = null;
let lastRealTime = null;

// Función para convertir hora UTC de ThingSpeak a hora Caracas (UTC-4)
function convertToCaracasTime(thingSpeakTime) {
  if (!thingSpeakTime) return null;
  
  try {
    // ThingSpeak devuelve UTC: "2025-12-05T10:30:00Z"
    const utcDate = new Date(thingSpeakTime);
    
    // Ajustar a Caracas (UTC-4)
    const caracasDate = new Date(utcDate.getTime() - (4 * 60 * 60000));
    
    return caracasDate;
  } catch (e) {
    return null;
  }
}

// Función para formatear fecha y hora
function formatDateTime(date) {
  if (!date) return "Hora no disponible";
  
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getDate() + 1).padStart(2, '0');
  const year = date.getFullYear();
  
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds} ${ampm}`;
}

// Función para calcular "Hace X minutos"
function getTimeAgo(caracasDate) {
  if (!caracasDate) return "--";
  
  const now = new Date();
  const diffMs = now - caracasDate;
  const diffMins = Math.floor(diffMs / 60000);
  
  if (diffMins < 1) return "Hace segundos";
  if (diffMins < 60) return `Hace ${diffMins} min`;
  if (diffMins < 1440) return `Hace ${Math.floor(diffMins/60)} horas`;
  return `Hace ${Math.floor(diffMins/1440)} días`;
}

// Función para obtener datos de ThingSpeak
async function getThingSpeakData() {
  try {
    const url = `https://api.thingspeak.com/channels/${CONFIG.channelId}/feeds/last.json?api_key=${CONFIG.apiKey}`;
    const response = await fetch(url);
    const data = await response.json();
    
    return {
      temperature: parseFloat(data.field1) || 0,
      timestamp: data.created_at,
      entryId: data.entry_id
    };
  } catch (e) {
    return { temperature: 0, timestamp: null, entryId: null };
  }
}

// Función para actualizar la pantalla
function updateDisplay(temp, timestamp) {
  // Actualizar termómetro
  const min = -15, max = 100;
  const pct = Math.max(0, Math.min(1, (temp - min) / (max - min)));
  document.getElementById("mercury").style.width = (pct * 100) + "%";
  document.getElementById("tempValue").textContent = temp.toFixed(1);
  
  // Actualizar hora
  const caracasDate = convertToCaracasTime(timestamp);
  const timeElement = document.getElementById("updateTime");
  
  if (caracasDate) {
    const timeAgo = getTimeAgo(caracasDate);
    const formattedTime = formatDateTime(caracasDate);
    timeElement.textContent = `Última medición: ${formattedTime} (${timeAgo})`;
  } else {
    timeElement.textContent = "Última medición: --/--/---- --:--:-- --";
  }
  
  // Actualizar alarmas
  updateAlarms(temp);
}

// Función para actualizar alarmas
function updateAlarms(temp) {
  const alarmBulb = document.getElementById("bulbAlarm");
  const alarmText = document.getElementById("alarmText");
  const resetBulb = document.getElementById("bulbReset");
  const resetText = document.getElementById("resetText");

  if (temp > CONFIG.alarm) {
    alarmBulb.className = "bulb-circle bulb-red";
    alarmBulb.textContent = "!";
    alarmText.textContent = "ACTIVADA";
  } else if (temp > 30) {
    alarmBulb.className = "bulb-circle bulb-yellow";
    alarmBulb.textContent = "⚠";
    alarmText.textContent = "ADVERTENCIA";
  } else {
    alarmBulb.className = "bulb-circle bulb-green";
    alarmBulb.textContent = "✓";
    alarmText.textContent = "Normal";
  }

  if (temp > CONFIG.reset) {
    resetBulb.className = "bulb-circle bulb-red";
    resetBulb.textContent = "!";
    resetText.textContent = "RECOMENDADO";
  } else {
    resetBulb.className = "bulb-circle bulb-off";
    resetBulb.textContent = "-";
    resetText.textContent = "No activo";
  }
}

// Función principal que se ejecuta periódicamente
async function checkForUpdates() {
  const data = await getThingSpeakData();
  
  // Guardar en localStorage para persistencia entre recargas
  if (data.timestamp) {
    localStorage.setItem('lastThingSpeakTime', data.timestamp);
    localStorage.setItem('lastThingSpeakTemp', data.temperature.toString());
  }
  
  // Usar datos guardados si no hay nuevos
  const storedTime = localStorage.getItem('lastThingSpeakTime') || data.timestamp;
  const storedTemp = parseFloat(localStorage.getItem('lastThingSpeakTemp')) || data.temperature;
  
  updateDisplay(storedTemp, storedTime);
}

// Cargar datos guardados al iniciar
window.addEventListener('load', function() {
  const storedTime = localStorage.getItem('lastThingSpeakTime');
  const storedTemp = localStorage.getItem('lastThingSpeakTemp');
  
  if (storedTime && storedTemp) {
    updateDisplay(parseFloat(storedTemp), storedTime);
  }
  
  // Hacer primera consulta inmediata
  checkForUpdates();
});

// Configurar intervalo de consulta (CAMBIAR AQUÍ EL TIEMPO)
// 30000 = 30 segundos, 60000 = 60 segundos, 120000 = 120 segundos
const CONSULTA_INTERVAL_MS = 60000; // ← CAMBIA ESTE VALOR

setInterval(checkForUpdates, CONSULTA_INTERVAL_MS);
</script>

</body>
</html>


