
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
:root{
--bg:#071427;
--card:#0b1220;
--accent:#00bcd4;
--muted:#9fb3c8;
--green:#00c853;
--yellow:#ffca28;
--orange:#ff9800;
--red:#ff1744;
--blue:#29b6f6;
--frame:#0d1a2e;
}

body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:var(--bg);
color:white;
min-height:100vh;
display:flex;
flex-direction:column;
padding:15px;
}

.page-frame {
background: var(--frame);
border-radius: 20px;
border: 2px solid rgba(0, 188, 212, 0.3);
box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6),
0 0 0 1px rgba(255, 255, 255, 0.05) inset;
max-width: 1000px;
width: 100%;
margin: 0 auto;
overflow: hidden;
flex: 1;
display: flex;
flex-direction:column;
}

.header{
padding:15px 20px;
background:linear-gradient(135deg, #0b1220, #071a33);
border-bottom:1px solid rgba(0,188,212,0.2);
}
.header-content{
display:flex;
gap:12px;
align-items:center;
max-width:900px;
margin:0 auto;
}

.header-logo{
width:47px;
height:30px;
border-radius:6px;
background:rgba(255,255,255,0.05);
padding:2px;
border:1px solid var(--accent);
display:flex;
align-items:center;
justify-content:center;
overflow:hidden;
}

.header-logo img{
width:150%;
height:150%;
object-fit:contain;
}

.header-text h1{
font-size:17px;
margin:0;
color:white;
}
.header-company{
color:var(--accent);
font-size:14px;
font-weight:600;
}
.header-subtitle{
font-size:12px;
color:var(--muted);
}

.container{
flex:1;
padding:20px;
display:flex;
flex-direction:column;
}

.thermo-card{
background:var(--card);
padding:25px 30px;
border-radius:18px;
border:1px solid rgba(255,255,255,0.05);
box-shadow:0 10px 30px rgba(0,0,0,0.4),
inset 0 1px 0 rgba(255,255,255,0.03);
margin-top:5px;
}

.thermo-wrap{
width:100%;
display:flex;
flex-direction:column;
align-items:center;
gap:20px;
}

.thermo-bar{
position:relative;
width:100%;
height:40px;
background:#0a1525;
border-radius:20px;
border:3px solid var(--yellow);
overflow:hidden;
margin-top:5px;
box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

.thermo-mercury{
position:absolute;
left:0;
top:0;
height:100%;
width:20%;
background:var(--green);
transition: width 1s ease;
box-shadow:inset 0 0 10px rgba(255,255,255,0.1);
}

.thermo-scale{
width:100%;
display:flex;
justify-content:space-between;
font-size:13px;
font-weight:600;
color:white;
margin-top:5px;
}

.temp-digital{
font-size:58px;
font-weight:800;
color:var(--yellow);
text-shadow:0 5px 20px rgba(255,255,0,0.3);
margin:10px 0 5px 0;
text-align:center;
}

.update-time {
font-size: 14px;
color: white;
text-align: center;
margin: 0 0 20px 0;
font-weight: 700;
opacity: 0.9;
}

.leds-container{
display:flex;
justify-content:center;
gap:50px;
width:100%;
margin-top:15px;
}

.led-bulb{
display:flex;
flex-direction:column;
align-items:center;
width:140px;
}

.bulb-circle{
width:100px;
height:100px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-size:32px;
font-weight:800;
margin-bottom:12px;
box-shadow:0 8px 25px rgba(0,0,0,0.7),
0 0 20px rgba(255,255,255,0.1) inset;
border:3px solid rgba(255,255,255,0.15);
transition: all 0.3s ease;
}

.bulb-label{
font-size:15px;
font-weight:700;
margin-bottom:5px;
color:white;
text-transform:uppercase;
letter-spacing:0.5px;
}

.bulb-status{
font-size:13px;
color:var(--muted);
font-weight:600;
}

.bulb-green{
background:radial-gradient(circle at 30% 30%, var(--green), #007a2b, #005a1f);
color:#fff;
text-shadow:0 2px 4px rgba(0,0,0,0.5);
}

.bulb-red{
background:radial-gradient(circle at 30% 30%, var(--red), #a1002b, #7a0021);
color:#fff;
text-shadow:0 2px 4px rgba(0,0,0,0.5);
}

.bulb-blue{
background:radial-gradient(circle at 30% 30%, var(--blue), #0077c2, #005a9c);
color:#fff;
text-shadow:0 2px 4px rgba(0,0,0,0.5);
}

.bulb-off{
background:radial-gradient(circle at 30% 30%, #444, #222, #111);
color:var(--muted);
}

.footer-copy{
text-align:center;
font-size:14px;
color:var(--blue);
margin-top:25px;
padding:20px 0;
font-weight:700;
border-top:1px solid rgba(255,255,255,0.08);
background:rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
body {
padding: 10px;
}

.page-frame {
border-radius: 15px;
}

.container {
padding: 15px;
}

.thermo-card {
padding: 20px;
}

.temp-digital {
font-size: 48px;
}

.update-time {
font-size: 13px;
}

.thermo-bar {
height: 35px;
}

.thermo-scale {
font-size: 11px;
}

.leds-container {
gap: 30px;
}

.led-bulb {
width: 120px;
}

.bulb-circle {
width: 80px;
height: 80px;
font-size: 28px;
}

.bulb-label {
font-size: 13px;
}

.bulb-status {
font-size: 11px;
}
}

@media (max-width: 480px) {
.temp-digital {
font-size: 42px;
}

.update-time {
font-size: 12px;
}

.thermo-bar {
height: 30px;
}

.thermo-scale {
font-size: 10px;
}

.leds-container {
gap: 20px;
flex-direction: row;
}

.led-bulb {
width: 100px;
}

.bulb-circle {
width: 70px;
height: 70px;
font-size: 24px;
}
}

</style>
</head>

<body>

<div class="page-frame">

<header class="header">
<div class="header-content">
<div class="header-logo">
<img src="logo-millares.png" alt="Logo Millares">
</div>
<div class="header-text">
<h1>MONITOREO DE VARIABLES</h1>
<div class="header-company">MILLARES INGENIERIA BAGB SPA IOT-CHILE</div>
<div class="header-subtitle">Temperatura · Alarma · Reset</div>
</div>
</div>
</header>

<div class="container">

<div class="thermo-card">
<div class="thermo-wrap">

<div class="thermo-bar">
<div id="mercury" class="thermo-mercury"></div>
</div>

<div class="thermo-scale">
<span>-15</span><span>0</span><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span>
</div>

<div class="temp-digital">
<span id="tempValue">0.0</span>°C
</div>

<div id="updateTime" class="update-time">
Última medición: --/--/---- --:--:-- --
</div>

<div class="leds-container">

<div class="led-bulb">
<div id="bulbAlarm" class="bulb-circle bulb-green">✓</div>
<div class="bulb-label">ALARMA</div>
<div id="alarmText" class="bulb-status">Normal</div>
</div>

<div class="led-bulb">
<div id="bulbReset" class="bulb-circle bulb-off">-</div>
<div class="bulb-label">RESET</div>
<div id="resetText" class="bulb-status">No activo</div>
</div>

</div>

</div>
</div>

<div class="footer-copy">
&copy; MILLARES INGENIERIA SPA CHILE
</div>

</div>

</div>

<script>
const CONFIG = {
  channelId: "3194050",
  apiKey: "4L6L63LNFO0YG4BB"
};

// Variables temporales
let resetActive = false;
let resetTimeout = null;
let lastValidTemp = 0;

// Función para convertir hora UTC a Caracas (UTC-4)
function convertToCaracasTime(thingSpeakTime) {
  if (!thingSpeakTime) return null;
  try {
    const utcDate = new Date(thingSpeakTime);
    const caracasDate = new Date(utcDate.getTime() - (4 * 60 * 60000));
    return caracasDate;
  } catch (e) {
    return null;
  }
}

// Función para formatear fecha y hora
function formatDateTime(date) {
  if (!date) return "Hora no disponible";
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds} ${ampm}`;
}

// Función para calcular "Hace X minutos"
function getTimeAgo(caracasDate) {
  if (!caracasDate) return "--";
  const now = new Date();
  const diffMs = now - caracasDate;
  const diffMins = Math.floor(diffMs / 60000);
  if (diffMins < 1) return "Hace segundos";
  if (diffMins < 60) return `Hace ${diffMins} min`;
  if (diffMins < 1440) return `Hace ${Math.floor(diffMins/60)} horas`;
  return `Hace ${Math.floor(diffMins/1440)} días`;
}

// Función para obtener datos de ThingSpeak
async function getThingSpeakData() {
  try {
    const url = `https://api.thingspeak.com/channels/${CONFIG.channelId}/feeds/last.json?api_key=${CONFIG.apiKey}`;
    const response = await fetch(url);
    const data = await response.json();
    
    return {
      temperature: parseFloat(data.field1) || 0,
      alarmState: parseInt(data.field2) || 0,
      resetState: parseInt(data.field3) || 0,
      timestamp: data.created_at,
      entryId: parseInt(data.entry_id) || 0
    };
  } catch (e) {
    return { 
      temperature: 0, 
      alarmState: 0, 
      resetState: 0,
      timestamp: null, 
      entryId: 0
    };
  }
}

// Función para actualizar la pantalla
function updateDisplay(temp, timestamp) {
  // Actualizar termómetro
  const min = -15, max = 100;
  const pct = Math.max(0, Math.min(1, (temp - min) / (max - min)));
  document.getElementById("mercury").style.width = (pct * 100) + "%";
  document.getElementById("tempValue").textContent = temp.toFixed(1);
  
  // Actualizar hora
  const caracasDate = convertToCaracasTime(timestamp);
  const timeElement = document.getElementById("updateTime");
  
  if (caracasDate) {
    const timeAgo = getTimeAgo(caracasDate);
    const formattedTime = formatDateTime(caracasDate);
    timeElement.textContent = `Última medición: ${formattedTime} (${timeAgo})`;
  } else {
    timeElement.textContent = "Última medición: --/--/---- --:--:-- --";
  }
}

// Función para procesar ALARMA y RESET desde ThingSpeak
function processAlarmReset(alarmState, resetState, entryId) {
  const alarmBulb = document.getElementById("bulbAlarm");
  const alarmText = document.getElementById("alarmText");
  const resetBulb = document.getElementById("bulbReset");
  const resetText = document.getElementById("resetText");
  
  // RESET TIENE PRIORIDAD TOTAL
  if (resetState === 1) {
    // 1. Activar reset (AZUL)
    resetBulb.className = "bulb-circle bulb-blue";
    resetBulb.textContent = "!";
    resetText.textContent = "ACTIVO";
    resetActive = true;
    
    // 2. Desactivar alarma (VERDE)
    alarmBulb.className = "bulb-circle bulb-green";
    alarmBulb.textContent = "✓";
    alarmText.textContent = "Normal";
    
    // 3. Apagar reset después de 5 segundos
    if (resetTimeout) clearTimeout(resetTimeout);
    resetTimeout = setTimeout(() => {
      resetBulb.className = "bulb-circle bulb-off";
      resetBulb.textContent = "-";
      resetText.textContent = "No activo";
      resetActive = false;
    }, 5000);
    
    return;
  }
  
  // SI NO HAY RESET, mostrar estado normal del reset
  if (!resetActive) {
    resetBulb.className = "bulb-circle bulb-off";
    resetBulb.textContent = "-";
    resetText.textContent = "No activo";
  }
  
  // CONTROL DE ALARMA (si no hay reset activo)
  if (alarmState === 1) {
    alarmBulb.className = "bulb-circle bulb-red";
    alarmBulb.textContent = "!";
    alarmText.textContent = "ACTIVADA";
  } else {
    alarmBulb.className = "bulb-circle bulb-green";
    alarmBulb.textContent = "✓";
    alarmText.textContent = "Normal";
  }
}

// Función principal que se ejecuta periódicamente
async function checkForUpdates() {
  try {
    const data = await getThingSpeakData();
    
    // Verificar si la temperatura es válida (no 0 y dentro de rango)
    const tempValida = data.temperature > -100 && data.temperature < 150;
    
    if (tempValida) {
      lastValidTemp = data.temperature;
      if (data.timestamp) {
        localStorage.setItem('lastThingSpeakTime', data.timestamp);
        localStorage.setItem('lastThingSpeakTemp', data.temperature.toString());
      }
    }
    
    // Usar la última temperatura válida
    const storedTime = localStorage.getItem('lastThingSpeakTime') || data.timestamp;
    
    // Actualizar temperatura y hora SIEMPRE con la última válida
    updateDisplay(lastValidTemp, storedTime);
    
    // Procesar estados ACTUALES de alarma y reset
    processAlarmReset(data.alarmState, data.resetState, data.entryId);
    
  } catch (error) {
    console.error("Error en checkForUpdates:", error);
  }
}

// Cargar datos guardados al iniciar
window.addEventListener('load', function() {
  const storedTime = localStorage.getItem('lastThingSpeakTime');
  const storedTemp = localStorage.getItem('lastThingSpeakTemp');
  
  if (storedTime && storedTemp) {
    lastValidTemp = parseFloat(storedTemp);
    updateDisplay(lastValidTemp, storedTime);
  }
  
  // Hacer primera consulta inmediata
  checkForUpdates();
});

// Configurar intervalo de consulta (10 segundos para respuesta rápida)
const CONSULTA_INTERVAL_MS = 10000;
setInterval(checkForUpdates, CONSULTA_INTERVAL_MS);
</script>

</body>
</html>
