
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>

<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="apple-touch-icon" href="logo-millares.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#020612 0%, #071427 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
  }

  /* HEADER */
  .main-header{
    padding:12px 15px;
    background:rgba(11,18,32,0.95);
    border-bottom:1px solid rgba(255,255,255,0.04);
    position:sticky;
    top:0;
    z-index:100;
    backdrop-filter:blur(5px);
  }
  .header-content{
    display:flex;
    align-items:center;
    gap:12px;
    max-width:900px;
    margin:0 auto;
  }
  .logo-img{
    width:42px;
    height:42px;
    border-radius:8px;
    object-fit:contain;
    background:rgba(255,255,255,0.05);
    padding:4px;
    border:1px solid rgba(0,188,212,0.2);
  }
  .header-text{
    flex:1;
  }
  .header-text h1{
    margin:0;
    font-size:17px;
    color:#fff;
    letter-spacing:0.5px;
  }
  .company-name{
    font-size:13px;
    color:#00bcd4;
    font-weight:600;
    margin-top:2px;
  }
  .header-subtitle{
    font-size:11px;
    color:var(--muted);
    margin-top:1px;
  }

  /* CONTENEDOR PRINCIPAL */
  .main-container{
    max-width:900px;
    margin:0 auto;
    padding:15px;
  }

  /* GAUGE */
  .gauge-section{
    background:var(--card);
    border-radius:12px;
    padding:20px 15px;
    margin-bottom:15px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 8px 25px rgba(2,6,23,0.5);
  }

  /* CONTENEDOR DEL DIAL */
  .gauge-container{
    position:relative;
    width:280px;
    height:160px;
    margin:0 auto;
  }

  .gauge-background{
    position:absolute;
    width:280px;
    height:140px;
    background:#0a1525;
    border-radius:0 0 140px 140px;
    border:6px solid rgba(255,255,255,0.05);
    border-top:none;
    box-shadow:inset 0 8px 15px rgba(0,0,0,0.6),
               0 4px 12px rgba(0,0,0,0.3);
    overflow:hidden;
  }

  .gauge-arc{
    position:absolute;
    width:280px;
    height:150px;
    background:conic-gradient(
      from 180deg,
      #00c853 0deg,
      #ffca28 90deg,
      #ff9800 135deg,
      #ff1744 180deg
    );
    border-radius:0 0 150px 150px;
    clip-path:polygon(0% 70%, 100% 70%, 100% 100%, 0% 100%);
    opacity:0.35;
  }

  /* MARCAS */
  .gauge-marks{
    position:absolute;
    width:100%;
    height:150px;
    top:10px;
  }
  .mark{
    position:absolute;
    width:2px;
    height:15px;
    background:white;
    transform-origin:50% 140px;
    left:calc(50% - 1px);
    top:0;
  }

  /* NUMEROS SOBRE U INVERTIDA */
  .gauge-numbers{
    position:absolute;
    width:100%;
    height:150px;
    top:10px;
  }
  .gauge-number{
    position:absolute;
    width:28px;
    text-align:center;
    font-size:13px;
    font-weight:700;
    text-shadow:0 1px 3px black;
    transform-origin:center;
  }

  /* AGUJA */
  .gauge-needle{
    --rot:0deg;
    position:absolute;
    width:3px;
    height:100px;
    background:linear-gradient(to top,#ffca28,#ff9800);
    left:calc(50% - 1.5px);
    top:10px;
    transform-origin:50% 140px;
    transform:rotate(var(--rot));
    z-index:20;
    border-radius:2px;
  }

  .needle-center{
    position:absolute;
    width:16px;
    height:16px;
    background:black;
    border:3px solid #ffca28;
    border-radius:50%;
    left:calc(50% - 8px);
    top:calc(150px - 8px);
    z-index:25;
  }

  /* TEMPERATURA DIGITAL */
  .temp-display{
    text-align:center;
    margin-top:10px;
  }
  .temp-value{
    font-size:42px;
    font-weight:800;
    color:#ffca28;
    margin-bottom:5px;
  }
  .temp-unit{
    font-size:22px;
    opacity:0.8;
  }

  /* ESTADOS (ALARMA / RESET) */
  .status-panel{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-top:20px;
  }
  .status-card{
    background:rgba(255,255,255,0.03);
    border-radius:10px;
    padding:12px;
    text-align:center;
  }
  .status-title{
    font-size:14px;
    font-weight:700;
    margin-bottom:8px;
  }
  .status-value{
    font-size:12px;
    opacity:0.8;
  }

  .status-led{
    width:60px;
    height:60px;
    margin:0 auto;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    font-weight:800;
  }
  .led-green{background:#00c853;}
  .led-yellow{background:#ffca28;}
  .led-red{background:#ff1744;}
  .led-off{background:#333;}

  .connection-info{
    text-align:center;
    margin-top:20px;
    font-size:11px;
    opacity:0.75;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="main-header">
  <div class="header-content">
    <img src="logo-millares.png" class="logo-img" alt="Logo">
    <div class="header-text">
      <h1>MONITOREO VARIABLES</h1>
      <div class="company-name">MILLARES BAGB SPA IOT CHILE</div>
      <div class="header-subtitle">Temperatura · Alarma · Reset</div>
    </div>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="main-container">

  <!-- GAUGE COMPLETO -->
  <section class="gauge-section">

    <div class="gauge-container">
      <div class="gauge-background"></div>
      <div class="gauge-arc"></div>

      <!-- Marcas corregidas -->
      <div id="gauge-marks" class="gauge-marks"></div>

      <!-- Números corregidos -->
      <div id="gauge-numbers" class="gauge-numbers"></div>

      <!-- Aguja corregida -->
      <div id="needle" class="gauge-needle" style="--rot:0deg"></div>
      <div class="needle-center"></div>
    </div>

    <!-- TEMP DIGITAL -->
    <div class="temp-display">
      <div class="temp-value" id="temp-digital">
        0.0<span class="temp-unit">°C</span>
      </div>
    </div>

    <!-- INFO -->
    <div class="connection-info" id="update-time">Última actualización: --</div>

    <!-- PANEL ESTADOS -->
    <div class="status-panel">

      <div class="status-card">
        <div class="status-title">Estado alarma</div>
        <div id="alarma-text" class="status-value">Normal</div>
        <div id="led-alarma" class="status-led led-green">✓</div>
      </div>

      <div class="status-card">
        <div class="status-title">Reset sistema</div>
        <div id="reset-text" class="status-value">No activo</div>
        <div id="led-reset" class="status-led led-off">-</div>
      </div>

    </div>

  </section>

  <footer class="main-footer">
    &copy; 2024 MILLARES BAGB SPA IOT CHILE - Sistema IoT
  </footer>

</main>

<script>
// ============================================================
// CONFIGURACIÓN THINGSPEAK
// ============================================================
const CONFIG = {
  thingspeak: {
    channelId: "3194050",
    readApiKey: "4L6L63LNFO0YG4BB",
    field: 1,
    url: "https://api.thingspeak.com/channels/"
  },
  updateInterval: 30000,
  alarmThreshold: 50,
  resetThreshold: 60,
  minTemp: -15,
  maxTemp: 100
};

// ============================================================
// INICIALIZAR GAUGE — MARCAS PERFECTAMENTE ALINEADAS
// ============================================================
function initGauge() {
  const marks = document.getElementById("gauge-marks");
  const nums = document.getElementById("gauge-numbers");

  const min = CONFIG.minTemp;
  const max = CONFIG.maxTemp;
  const range = max - min;

  const radiusMarks = 125;
  const radiusNums = 100;

  const cx = 140;
  const cy = 140;

  // NÚMEROS EXACTOS QUE QUIERES
  const numbers = [-15, 0, 25, 50, 75, 100];

  numbers.forEach(temp => {
    const percent = (temp - min) / range;
    const angle = 180 - percent * 180; // 180° izq → 0° der
    const rad = (angle * Math.PI) / 180;

    // ------ MARCA (RAYA) ------
    const x1 = cx + Math.cos(rad) * radiusMarks;
    const y1 = cy - Math.sin(rad) * radiusMarks;

    const mark = document.createElement("div");
    mark.className = "gauge-mark";
    mark.style.left = `${x1}px`;
    mark.style.top = `${y1}px`;
    mark.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
    marks.appendChild(mark);

    // ------ NÚMERO ------
    const x2 = cx + Math.cos(rad) * radiusNums;
    const y2 = cy - Math.sin(rad) * radiusNums;

    const num = document.createElement("div");
    num.className = "gauge-number";
    num.textContent = temp;
    num.style.left = `${x2}px`;
    num.style.top = `${y2}px`;
    num.style.transform = "translate(-50%, -50%)";
    nums.appendChild(num);
  });
}

// ============================================================
// OBTENER DATOS THINGSPEAK
// ============================================================
async function fetchThingSpeakData() {
  const { channelId, readApiKey, field, url } = CONFIG.thingspeak;
  const apiUrl = `${url}${channelId}/fields/${field}/last.json?api_key=${readApiKey}`;

  try {
    const r = await fetch(apiUrl);
    if (!r.ok) throw new Error("HTTP error");
    const j = await r.json();
    return parseFloat(j[`field${field}`]);
  } catch {
    return null;
  }
}

// ============================================================
// ACTUALIZAR GAUGE — AGUJA PERFECTAMENTE CALIBRADA
// ============================================================
function updateGauge(temp) {
  const needle = document.getElementById("needle");
  const digital = document.getElementById("temp-digital");

  if (temp == null) return;

  digital.innerHTML = temp.toFixed(1) + "<span class='temp-unit'>°C</span>";

  const min = CONFIG.minTemp;
  const max = CONFIG.maxTemp;

  const clamped = Math.max(min, Math.min(max, temp));
  const percent = (clamped - min) / (max - min);

  const angle = 180 - percent * 180; // ← AGUJA AL 100% CORRECTA

  needle.style.setProperty("--rot", `${angle}deg`);
}

// ============================================================
// ESTADOS (ALARMA + RESET)
// ============================================================
function updateStatus(temp) {
  const alarmLed = document.getElementById("led-alarma");
  const alarmText = document.getElementById("alarma-text");
  const resetLed = document.getElementById("led-reset");
  const resetText = document.getElementById("reset-text");

  // ---- ALARMA ----
  if (temp > CONFIG.alarmThreshold) {
    alarmLed.className = "status-led led-red";
    alarmLed.textContent = "!";
    alarmText.textContent = "ALARMA";
    alarmText.style.color = "#ff1744";
  } else if (temp > 30) {
    alarmLed.className = "status-led led-yellow";
    alarmLed.textContent = "⚠";
    alarmText.textContent = "ADVERTENCIA";
    alarmText.style.color = "#ffca28";
  } else {
    alarmLed.className = "status-led led-green";
    alarmLed.textContent = "✓";
    alarmText.textContent = "Normal";
    alarmText.style.color = "";
  }

  // ---- RESET ----
  if (temp > CONFIG.resetThreshold) {
    resetLed.className = "status-led led-red";
    resetLed.textContent = "!";
    resetText.textContent = "RESET RECOMENDADO";
    resetText.style.color = "#ff1744";
  } else {
    resetLed.className = "status-led led-off";
    resetLed.textContent = "-";
    resetText.textContent = "No activo";
    resetText.style.color = "";
  }
}

// ============================================================
// TIMESTAMP
// ============================================================
function updateTimestamp(ok = true) {
  const now = new Date();
  document.getElementById("update-time").textContent =
    "Última actualización: " +
    now.toLocaleDateString("es-CL") +
    " " +
    now.toLocaleTimeString("es-CL");
}

// ============================================================
// FUNCIÓN PRINCIPAL
// ============================================================
async function updateDashboard() {
  const t = await fetchThingSpeakData();
  updateGauge(t);
  updateStatus(t);
  updateTimestamp();
}

// ============================================================
// INICIALIZAR TODO
// ============================================================
document.addEventListener("DOMContentLoaded", () => {
  initGauge();
  updateDashboard();
  setInterval(updateDashboard, CONFIG.updateInterval);
});
</script>
</body>
</html>

  
