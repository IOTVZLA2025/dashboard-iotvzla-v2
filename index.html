<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="apple-touch-icon" href="logo-millares.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#020612 0%, #071427 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  header{
    padding:14px 18px;
    border-bottom:1px solid rgba(255,255,255,0.04);
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .logo-container {
    display:flex;
    align-items:center;
    gap:12px;
    flex:1;
    min-width:250px;
  }
  .logo-img {
    width:44px;
    height:44px;
    border-radius:10px;
    object-fit:contain;
    background:rgba(255,255,255,0.05);
    padding:4px;
  }
  .header-text {
    flex:1;
    min-width:200px;
  }
  .header-text h1{
    margin:0;
    font-size:18px;
    letter-spacing:0.6px;
    color:#fff;
  }
  .header-text .subtitle{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }
  .header-text .company-name{
    font-size:14px;
    color:#00bcd4;
    font-weight:600;
    margin-top:2px;
  }
  .container{max-width:980px;margin:18px auto;padding:12px;}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
    margin-bottom:12px
  }
  .main-grid{
    display:grid;
    grid-template-columns:1fr 360px;
    gap:14px
  }
  @media(max-width:820px){
    .main-grid{
      grid-template-columns:1fr;
    }
    .gauge-container{
      transform:scale(0.9);
    }
    header{
      padding:12px 14px;
    }
    .logo-container{
      min-width:100%;
      justify-content:center;
      text-align:center;
      margin-bottom:8px;
    }
    .header-text{
      text-align:center;
    }
  }
  @media(max-width:480px){
    .gauge-container{
      transform:scale(0.8);
      margin:-10px 0;
    }
    .container{
      padding:8px;
    }
  }

  /* Gauge area - NUEVO DISEÑO */
  .gauge-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:10px;
  }
  .gauge-container {
    position:relative;
    width:280px;
    height:140px;
    margin:0 auto;
    overflow:hidden;
  }
  
  /* Semicírculo del gauge */
  .gauge-semicircle {
    position:absolute;
    width:280px;
    height:280px;
    border-radius:50%;
    background:conic-gradient(
      from 180deg,
      transparent 0deg,
      transparent 45deg,
      rgba(0,188,212,0.1) 45deg,
      rgba(0,188,212,0.3) 90deg,
      rgba(0,188,212,0.5) 135deg,
      rgba(0,188,212,0.8) 180deg,
      rgba(0,188,212,1) 225deg,
      rgba(0,188,212,0.8) 270deg,
      rgba(0,188,212,0.5) 315deg,
      transparent 315deg,
      transparent 360deg
    );
    clip-path:polygon(0% 100%, 100% 100%, 100% 50%, 0% 50%);
    transform:rotate(225deg);
  }
  
  /* Líneas de marcación */
  .gauge-ticks {
    position:absolute;
    width:100%;
    height:100%;
  }
  .tick {
    position:absolute;
    width:2px;
    height:12px;
    background:rgba(255,255,255,0.5);
    transform-origin:50% 140px;
    left:calc(50% - 1px);
    top:0;
  }
  .tick.major {
    width:3px;
    height:18px;
    background:#fff;
  }
  
  /* Números del gauge */
  .gauge-numbers {
    position:absolute;
    width:100%;
    height:100%;
    color:var(--muted);
    font-size:12px;
    font-weight:600;
  }
  .number {
    position:absolute;
    transform-origin:50% 140px;
    left:50%;
    top:25px;
    transform:translateX(-50%) rotate(var(--rot));
    text-align:center;
  }
  
  /* Aguja */
  .gauge-needle {
    --rot:225deg;
    position:absolute;
    width:3px;
    height:100px;
    background:linear-gradient(to top, #fff, #ccecff);
    border-radius:2px;
    transform-origin:50% 140px;
    left:calc(50% - 1.5px);
    top:0;
    transform:rotate(var(--rot));
    z-index:10;
    box-shadow:0 0 10px rgba(0,188,212,0.5);
  }
  
  /* Centro de la aguja */
  .needle-center {
    position:absolute;
    width:20px;
    height:20px;
    background:#0b1220;
    border:3px solid var(--accent);
    border-radius:50%;
    left:calc(50% - 10px);
    top:calc(140px - 10px);
    z-index:11;
    box-shadow:0 0 15px rgba(0,188,212,0.3);
  }
  
  /* Display de temperatura debajo del centro */
  .temp-display {
    position:absolute;
    top:150px;
    left:50%;
    transform:translateX(-50%);
    text-align:center;
    width:100%;
  }
  .temp-value {
    font-size:42px;
    font-weight:800;
    color:#fff;
    text-shadow:0 4px 15px rgba(0,0,0,0.6);
    line-height:1;
  }
  .temp-unit {
    font-size:20px;
    color:var(--muted);
    margin-left:4px;
  }
  .temp-label {
    font-size:14px;
    color:var(--muted);
    margin-top:4px;
  }

  /* right column */
  .right-col{display:flex;flex-direction:column;gap:12px}
  .status-card{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));
    border:1px solid rgba(255,255,255,0.02)
  }
  .led{
    width:84px;
    height:84px;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:20px;
    color:#042;
    box-shadow:0 8px 20px rgba(0,0,0,0.6)
  }
  .led.green{
    background:linear-gradient(180deg,var(--ok),#007a2b);
    color:#021
  }
  .led.red{
    background:linear-gradient(180deg,var(--danger),#a1002b);
    color:#250005
  }
  .led.yellow{
    background:linear-gradient(180deg,var(--yellow),#b37a00);
    color:#2b1a00
  }
  .led-label{font-size:13px;color:var(--muted)}
  .last-up{font-size:13px;color:var(--muted)}
  .banner{padding:10px;border-radius:8px;text-align:center;font-weight:700}
  .banner.reset{background:linear-gradient(90deg,#352e0b, #7a5d00);color:#fff}
  .banner.warn{background:linear-gradient(90deg,#311000,#6b0000);color:#fff}
  footer{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  .card-title{font-weight:700;margin-bottom:8px}
  .info-row{display:flex;gap:12px;align-items:center}
  .range-label{
    font-size:14px;
    color:var(--muted);
    padding:6px 10px;
    border-radius:8px;
    background:rgba(255,255,255,0.02)
  }
</style>
</head>
<body>
<header>
  <div class="logo-container">
    <!-- Logo de Millares -->
    <img src="logo-millares.png" alt="Logo Millares" class="logo-img">
    <div class="header-text">
      <h1>MONITOREO VARIABLES</h1>
      <div class="company-name">MILLARES BAGB SPA IOT CHILE</div>
      <div class="subtitle">Temperatura · Alarma · Reset — Pantalla para cliente</div>
    </div>
  </div>
</header>

<div class="container">
  <div class="main-grid">
    <div class="card">
      <div class="gauge-wrap">
        <div class="gauge-container">
          <!-- Semicírculo del gauge -->
          <div class="gauge-semicircle"></div>
          
          <!-- Marcaciones -->
          <div class="gauge-ticks" id="gauge-ticks"></div>
          
          <!-- Números -->
          <div class="gauge-numbers" id="gauge-numbers"></div>
          
          <!-- Aguja -->
          <div class="gauge-needle" id="needle" style="--rot:225deg"></div>
          
          <!-- Centro -->
          <div class="needle-center"></div>
          
          <!-- Display de temperatura -->
          <div class="temp-display">
            <div class="temp-value" id="temp-digital">--.-<span class="temp-unit">°C</span></div>
            <div class="temp-label">TEMPERATURA ACTUAL</div>
          </div>
        </div>

        <!-- Texto bajo el dial -->
        <div id="gauge-sub" class="meta-center" style="margin-top:120px">
          Última actualización: --
        </div>
        <div style="margin-top:10px;display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div class="range-label">
            <b>RANGO IDEAL:</b> 20 y 30 °C
          </div>
          <div class="range-label" style="font-size:14px;">
            Actualización automática cada <b>30 s</b>
          </div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card status-card">
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;width:100%">
          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Estado alarma</div>
              <div id="alarma-text" class="small">No hay alarma</div>
            </div>
            <div id="led-alarma" class="led green">✓</div>
          </div>

          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Reset</div>
              <div id="reset-text" class="small">No activo</div>
            </div>
            <div id="led-reset" class="led" style="background:rgba(255,255,255,0.02);color:var(--muted)">-</div>
          </div>

          <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <div class="last-up" id="last-up">Último ping: --</div>
            <div class="small" id="status-http">Conexión: --</div>
          </div>
        </div>
      </div>

      <div id="reset-banner" class="card banner reset" style="display:none">RESET ENVIADO</div>
      <div id="alarm-banner" class="card banner warn" style="display:none">ALARMA ACTIVADA</div>

      <div class="card">
        <div class="card-title">Información del sistema</div>
        <div class="small">
          Sistema de monitoreo IoT en tiempo real. Las actualizaciones se realizan automáticamente cada 30 segundos.
        </div>
      </div>
    </div>
  </div>
  
  <footer>
    &copy; 2024 MILLARES BAGB SPA IOT CHILE - Todos los derechos reservados
  </footer>
</div>

<script>
  // =============================================
  // CONFIGURACIÓN - REEMPLAZAR CON TUS CREDENCIALES
  // =============================================
  const CONFIG = {
    thingspeak: {
      channelId: '3194050',      // Ejemplo: '1234567'
      readApiKey: '4L6L63LNFO0YG4BB',  // Ejemplo: 'ABCDEFGHIJKLMNOP'
      field: 1,                         // Número del campo (1 para temperatura)
      url: 'https://api.thingspeak.com/channels/'
    },
    updateInterval: 30000, // 30 segundos
    alarmThreshold: 50,    // °C para activar alarma
    resetThreshold: 60     // °C para mostrar reset recomendado
  };

  // =============================================
  // INICIALIZACIÓN DEL GAUGE (marcas y números)
  // =============================================
  function initGauge() {
    const ticksContainer = document.getElementById('gauge-ticks');
    const numbersContainer = document.getElementById('gauge-numbers');
    
    // Rango: 15°C a 100°C
    const minTemp = 15;
    const maxTemp = 100;
    const range = maxTemp - minTemp;
    
    // Ángulo: 225° (izquierda) a 315° (derecha) = 90° de arco
    const startAngle = 225; // grados
    const endAngle = 315;   // grados
    const angleRange = endAngle - startAngle;
    
    // Crear marcas cada 5°C
    for (let temp = minTemp; temp <= maxTemp; temp += 5) {
      // Calcular posición angular
      const percent = (temp - minTemp) / range;
      const angle = startAngle + (percent * angleRange);
      
      // Crear marca
      const tick = document.createElement('div');
      tick.className = temp % 25 === 0 ? 'tick major' : 'tick';
      tick.style.transform = `rotate(${angle}deg)`;
      ticksContainer.appendChild(tick);
      
      // Crear número para marcas principales (cada 25°C)
      if (temp % 25 === 0) {
        const number = document.createElement('div');
        number.className = 'number';
        number.textContent = temp;
        number.style.setProperty('--rot', `-${angle}deg`);
        numbersContainer.appendChild(number);
      }
    }
  }

  // =============================================
  // FUNCIONES PRINCIPALES
  // =============================================
  
  // Función para obtener datos de ThingSpeak
  async function fetchThingSpeakData() {
    const { channelId, readApiKey, field, url } = CONFIG.thingspeak;
    const apiUrl = `${url}${channelId}/fields/${field}/last.json?api_key=${readApiKey}`;
    
    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('Error en la respuesta');
      
      const data = await response.json();
      return parseFloat(data[`field${field}`]) || 0;
    } catch (error) {
      console.error('Error fetching ThingSpeak:', error);
      // Simular datos si hay error (para prueba)
      return 20 + Math.random() * 40;
    }
  }

  // Función para actualizar la temperatura
  function updateGauge(temp) {
    const needle = document.getElementById('needle');
    const tempDigital = document.getElementById('temp-digital');
    
    // Actualizar valor digital
    tempDigital.textContent = temp.toFixed(1);
    
    // Calcular ángulo (15°C = 225°, 100°C = 315°)
    const minTemp = 15;
    const maxTemp = 100;
    const clampedTemp = Math.max(minTemp, Math.min(maxTemp, temp));
    const percent = (clampedTemp - minTemp) / (maxTemp - minTemp);
    const angle = 225 + (percent * 90); // 225° a 315°
    
    // Actualizar aguja
    needle.style.setProperty('--rot', `${angle}deg`);
    
    // Cambiar color según temperatura
    if (temp >= 20 && temp <= 30) {
      tempDigital.style.color = '#00c853'; // Verde (ideal)
    } else if (temp > 30 && temp <= 50) {
      tempDigital.style.color = '#ffca28'; // Amarillo (precaución)
    } else if (temp > 50 && temp <= CONFIG.alarmThreshold) {
      tempDigital.style.color = '#ff9800'; // Naranja (alerta)
    } else if (temp > CONFIG.alarmThreshold) {
      tempDigital.style.color = '#ff1744'; // Rojo (peligro/alarma)
    } else {
      tempDigital.style.color = '#00bcd4'; // Azul (frío)
    }
    
    return temp;
  }

  // Función para actualizar estados de alarma y reset
  function updateStatus(temp) {
    const alarmLed = document.getElementById('led-alarma');
    const alarmText = document.getElementById('alarma-text');
    const resetLed = document.getElementById('led-reset');
    const resetText = document.getElementById('reset-text');
    const alarmBanner = document.getElementById('alarm-banner');
    const resetBanner = document.getElementById('reset-banner');
    
    // Estado de alarma
    if (temp > CONFIG.alarmThreshold) {
      alarmLed.className = 'led red';
      alarmLed.textContent = '!';
      alarmText.textContent = 'ALARMA ACTIVADA';
      alarmText.style.color = '#ff1744';
      alarmBanner.style.display = 'block';
    } else if (temp > 30) {
      alarmLed.className = 'led yellow';
      alarmLed.textContent = '⚠';
      alarmText.textContent = 'ADVERTENCIA';
      alarmText.style.color = '#ffca28';
      alarmBanner.style.display = 'none';
    } else {
      alarmLed.className = 'led green';
      alarmLed.textContent = '✓';
      alarmText.textContent = 'No hay alarma';
      alarmText.style.color = '';
      alarmBanner.style.display = 'none';
    }
    
    // Estado de reset
    if (temp > CONFIG.resetThreshold) {
      resetLed.className = 'led red';
      resetLed.textContent = '!';
      resetText.textContent = 'RESET RECOMENDADO';
      resetText.style.color = '#ff1744';
      resetBanner.style.display = 'block';
    } else {
      resetLed.className = 'led';
      resetLed.style.background = 'rgba(255,255,255,0.02)';
      resetLed.style.color = 'var(--muted)';
      resetLed.textContent = '-';
      resetText.textContent = 'No activo';
      resetText.style.color = '';
      resetBanner.style.display = 'none';
    }
  }

  // Función para actualizar timestamp y estado de conexión
  function updateTimestamp(success = true) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-CL', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit' 
    });
    const dateStr = now.toLocaleDateString('es-CL');
    
    document.getElementById('gauge-sub').textContent = `Última actualización: ${dateStr} ${timeStr}`;
    document.getElementById('last-up').textContent = `Último ping: ${timeStr}`;
    
    // Estado de conexión
    const statusEl = document.getElementById('status-http');
    if (success) {
      statusEl.textContent = 'Conexión: OK';
      statusEl.style.color = '#00c853';
    } else {
      statusEl.textContent = 'Conexión: ERROR';
      statusEl.style.color = '#ff1744';
    }
  }

  // Función principal de actualización
  async function updateDashboard() {
    try {
      const temperature = await fetchThingSpeakData();
      updateGauge(temperature);
      updateStatus(temperature);
      updateTimestamp(true);
    } catch (error) {
      console.error('Error en actualización:', error);
      updateTimestamp(false);
    }
  }

  // =============================================
  // INICIALIZACIÓN
  // =============================================
  document.addEventListener('DOMContentLoaded', function() {
    // Inicializar gauge
    initGauge();
    
    // Actualizar inmediatamente
    updateDashboard();
    
    // Actualizar cada 30 segundos
    setInterval(updateDashboard, CONFIG.updateInterval);
    
    // También actualizar el timestamp cada minuto (por si hay timeout)
    setInterval(() => updateTimestamp(true), 60000);
  });
</script>
</body>
</html>
