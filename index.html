
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MONITOREO IOTVZLA</title>

<style>
:root{
  --bg:#071427;
  --card:#0b1220;
  --accent:#00bcd4;
  --muted:#9fb3c8;
  --ok:#00c853;
  --warn:#ffca28;
  --danger:#ff1744;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#071427;
  color:#e9eef6;
  font-family:Arial,Helvetica,sans-serif;
  padding:10px;
}

/* ===== TARJETA PRINCIPAL ===== */
.card{
  background:#0b1220;
  padding:15px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.05);
  max-width:900px;
  margin:0 auto;
  box-shadow:0 6px 18px rgba(0,0,0,0.4);
}

/* ========= GAUGE INDUSTRIAL ========= */
.gauge-box{
  width:100%;
  text-align:center;
}

.gauge-container{
  width:340px;
  height:180px;
  margin:0 auto;
  position:relative;
}

/* arco general */
.gauge-arc{
  position:absolute;
  width:100%;
  height:100%;
  top:0;
  left:0;
}

/* arco de colores */
.arc-segment{
  position:absolute;
  width:100%;
  height:100%;
  top:0;
  left:0;
  border-radius:340px 340px 0 0;
  border:18px solid transparent;
  border-bottom:none;
  transform-origin:50% 100%;
}

/* verde 0-30°C */
.arc-green{
  border-top-color:var(--ok);
  transform:rotate(180deg);
}

/* amarillo 30-50°C */
.arc-yellow{
  border-top-color:var(--warn);
  transform:rotate(135deg);
}

/* rojo 50-100°C */
.arc-red{
  border-top-color:var(--danger);
  transform:rotate(90deg);
}

/* rayas */
.tick{
  position:absolute;
  width:2px;
  height:14px;
  background:#fff;
  left:50%;
  transform-origin:50% 150px;
  opacity:0.8;
}
.tick.small{
  height:8px;
  opacity:0.5;
}

/* números */
.num{
  position:absolute;
  color:#fff;
  font-size:14px;
  font-weight:bold;
  text-shadow:0 0 4px #000;
  transform:translate(-50%, -50%);
}

/* aguja */
.needle{
  position:absolute;
  width:4px;
  height:120px;
  background:linear-gradient(to bottom, #fff, #ffca28);
  left:50%;
  top:20px;
  border-radius:2px;
  transform-origin:50% 110px;
}
.needle-center{
  position:absolute;
  width:16px;
  height:16px;
  background:#000;
  border:3px solid #ffca28;
  border-radius:50%;
  left:50%;
  top:115px;
  transform:translate(-50%,0);
}

/* temperatura digital */
.temp-digital{
  font-size:45px;
  margin-top:10px;
  font-weight:bold;
  color:#00e676;
  text-shadow:0 2px 6px rgba(0,0,0,0.5);
}

/* info */
.info{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
  text-align:center;
}

/* led */
.led-box{
  margin-top:15px;
}
.led{
  width:75px;
  height:75px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
  margin:auto;
  margin-bottom:5px;
}
.led.green{background:var(--ok);}
.led.yellow{background:var(--warn);color:#000;}
.led.red{background:var(--danger);}
.led.off{background:#333;}

.status-text{
  text-align:center;
  font-size:15px;
  font-weight:bold;
  color:#fff;
}

/* conexión */
.connection{
  margin-top:8px;
  text-align:center;
  font-size:13px;
}
</style>
</head>

<body>

<div class="card">

  <div class="gauge-box">
    <div class="gauge-container" id="gauge">
      <!-- Arcos -->
      <div class="arc-segment arc-green"></div>
      <div class="arc-segment arc-yellow"></div>
      <div class="arc-segment arc-red"></div>

      <!-- Aguja -->
      <div class="needle" id="needle"></div>
      <div class="needle-center"></div>

      <!-- Ticks -->
      <div id="ticks"></div>

      <!-- Números -->
      <div id="numbers"></div>
    </div>

    <div class="temp-digital" id="tempDigital">0.0°C</div>

    <div class="info" id="timeInfo">Última actualización: --</div>
    <div class="info">Actualización automática cada 30 segundos</div>
  </div>

  <!-- LED ALARMA -->
  <div class="led-box">
    <div class="led off" id="ledAlarm">-</div>
    <div class="status-text" id="alarmText">Sin alarma</div>

    <div class="led off" id="ledReset" style="margin-top:20px;">-</div>
    <div class="status-text" id="resetText">Sin reset</div>
  </div>

  <div class="connection" id="conn">Conexión: --</div>
</div>

<script>
/* ===========================
   AJUSTA TUS DATOS AQUI
   =========================== */
const CONFIG = {
  channel: "3194050",
  apiKey: "4L6L63LNFO0YG4BB",
  field: 1,
  interval: 30000
};

/* ===========================
   GENERAR TICKS Y NÚMEROS
   =========================== */
function initGauge() {
  const ticks = document.getElementById("ticks");
  const nums = document.getElementById("numbers");

  const MIN = -15;
  const MAX = 100;
  const RANGE = MAX - MIN;

  for (let t = MIN; t <= MAX; t += 5) {
    const percent = (t - MIN) / RANGE;
    const angle = 180 - percent * 180;

    const tick = document.createElement("div");
    tick.className = "tick" + (t % 25 === 0 ? "" : " small");
    tick.style.transform = `rotate(${angle}deg)`;
    ticks.appendChild(tick);

    if (t % 25 === 0 || t === MIN || t === MAX) {
      const num = document.createElement("div");
      num.className = "num";

      const r = 135;
      const rad = angle * Math.PI / 180;
      const x = 170 + Math.cos(rad) * r;
      const y = 170 - Math.sin(rad) * r;

      num.style.left = `${x}px`;
      num.style.top = `${y}px`;
      num.textContent = t;
      nums.appendChild(num);
    }
  }
}

/* ===========================
   LECTURA THINGSPEAK
   =========================== */
async function readTS() {
  const url = `https://api.thingspeak.com/channels/${CONFIG.channel}/fields/${CONFIG.field}/last.json?api_key=${CONFIG.apiKey}`;

  try {
    const r = await fetch(url);
    const j = await r.json();
    return parseFloat(j[`field${CONFIG.field}`]);
  } catch (e) {
    return null;
  }
}

/* ===========================
   ACTUALIZAR INTERFAZ
   =========================== */
function updateGauge(temp) {
  const MIN = -15;
  const MAX = 100;

  // digital
  document.getElementById("tempDigital").textContent = temp.toFixed(1) + "°C";

  // aguja
  const pct = (temp - MIN) / (MAX - MIN);
  const angle = 180 - pct * 180;
  document.getElementById("needle").style.transform = `rotate(${angle}deg)`;

  // alarma
  const ledA = document.getElementById("ledAlarm");
  const txtA = document.getElementById("alarmText");

  if (temp >= 50) {
    ledA.className = "led red";
    ledA.textContent = "!";
    txtA.textContent = "ALARMA CRÍTICA";
  } else if (temp >= 30) {
    ledA.className = "led yellow";
    ledA.textContent = "⚠";
    txtA.textContent = "ADVERTENCIA";
  } else {
    ledA.className = "led green";
    ledA.textContent = "✓";
    txtA.textContent = "Normal";
  }
}

/* ===========================
   CICLO PRINCIPAL
   =========================== */
async function updateAll() {
  const temp = await readTS();
  const c = document.getElementById("conn");

  if (temp === null) {
    c.textContent = "Conexión: ERROR";
    c.style.color = "#ff1744";
    return;
  }

  c.textContent = "Conexión: OK";
  c.style.color = "#00c853";

  updateGauge(temp);

  document.getElementById("timeInfo").textContent =
    "Última actualización: " + new Date().toLocaleString("es-CL");
}

/* ===========================
   INICIO
   =========================== */
initGauge();
updateAll();
setInterval(updateAll, CONFIG.interval);
</script>

</body>
</html>
