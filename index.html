

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO IOTVZLA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />
<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#020612 0%, #071427 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  header{
    padding:14px 18px;
    border-bottom:1px solid rgba(255,255,255,0.04);
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:center;
    text-align:center;
  }
  header h1{
    margin:0;
    font-size:18px;
    letter-spacing:0.6px;
    color:#ffffff;
  }
  .header-sub{
    font-size:14px;
    color:#4fc3f7;
    font-weight:600;
    margin-top:2px;
    white-space:nowrap;
  }
  .container{max-width:980px;margin:18px auto;padding:12px;}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
    margin-bottom:12px;
  }
  .main-grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media(max-width:820px){
    .main-grid{grid-template-columns:1fr}
    .header-sub{white-space:normal}
  }

  /* Gauge area */
  .gauge-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:0px;
  }
  .gauge-card{
    width:100%;
    display:flex;
    align-items:center;
    gap:18px;
    padding:8px;
    justify-content:center;
    margin-top:-25px;
  }
  .gauge{
    width:200px;
    height:100px;
    border-radius:200px 200px 0 0;
    background:
      conic-gradient(from 180deg at 50% 100%, var(--yellow) 0deg, var(--yellow) 180deg),
      radial-gradient(ellipse farthest-corner at 50% 0%, #0b1220 52%, transparent 52%);
    box-shadow: inset 0 -15px 30px rgba(0,0,0,0.7), 0 8px 30px rgba(3,8,20,0.6);
    position:relative;
    border: 6px solid rgba(255,255,255,0.15);
    border-bottom: none;
  }
  
  /* POSICIONES CORREGIDAS - Números en arco semicircular */
  .scale-mark{
    position:absolute;
    font-size:11px;
    font-weight:700;
    color:rgba(255,255,255,0.9);
    text-shadow:0 1px 3px rgba(0,0,0,0.8);
  }
  
  /* Distribución en arco semicircular perfecto */
  /* Ajusta estos valores si es necesario */
  .gauge .scale-mark:nth-child(1) { left: -15%; bottom: -10%; }   /* -15°C (izquierda) */
  .gauge .scale-mark:nth-child(2) { left:  -10%; bottom:  25%; }   /* 0°C */
  .gauge .scale-mark:nth-child(3) { left:  -5%;  bottom:  55%; }   /* 10°C */
  .gauge .scale-mark:nth-child(4) { left:   3%;  bottom:  85%; }   /* 20°C */
  .gauge .scale-mark:nth-child(5) { left:   15%;  bottom: 100%; }   /* 30°C */
  .gauge .scale-mark:nth-child(6) { left:   25%; bottom:   85%; }   /* 40°C */
  .gauge .scale-mark:nth-child(7) { left:   40%; bottom:  120%; }   /* 50°C */
  .gauge .scale-mark:nth-child(8) { left:   70%; bottom:  130%; }   /* 60°C */
  .gauge .scale-mark:nth-child(9) { left: 90%; bottom: 28%; }   /* 70°C */
  .gauge .scale-mark:nth-child(10) { left: 91%; bottom: 12%; }  /* 80°C */
  .gauge .scale-mark:nth-child(11) { left: 88%; bottom: -2%; }  /* 100°C (derecha) */
  
  .temp-display{
    position:absolute;
    bottom:-35px;
49 left:50%;
    transform:translateX(-50%);
    text-align:center;
    z-index:5;
  }
  .temp-value{
    font-size:28px;
    font-weight:800;
    color:#fff;
    text-shadow:0 6px 20px rgba(0,0,0,0.6);
  }
  .temp-unit{
    font-size:18px;
    color:var(--muted);
    margin-top:2px;
  }
  .gauge-needle{
    --rot:0deg;
    position:absolute;
    bottom:-5px;
    left:50%;
    width:4px;
    height:80px;
    background:linear-gradient(to top,#fff,#ccecff);
    border-radius:2px;
    transform-origin:50% 100%;
    transform:translateX(-50%) rotate(var(--rot));
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
    z-index:3;
  }
  .gauge-center-dot{
    position:absolute;
    width:18px;
    height:18px;
    border-radius:50%;
    background:linear-gradient(180deg,#031017,#0b1220);
    border:3px solid rgba(255,255,255,0.15);
    z-index:4;
    bottom:2px;
    left:50%;
    transform:translateX(-50%);
  }
  .meta{font-size:13px;color:var(--muted);margin-top:8px}

  /* right column */
  .right-col{display:flex;flex-direction:column;gap:12px}
  .status-card{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.18));
    border:1px solid rgba(255,255,255,0.02);
  }
  .led{
    width:84px;
    height:84px;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:20px;
    color:#042;
    box-shadow:0 8px 20px rgba(0,0,0,0.6);
  }
  .led.green{background:linear-gradient(180deg,var(--ok),#007a2b);color:#021}
  .led.red{background:linear-gradient(180deg,var(--danger),#a1002b);color:#250005}
  .led.yellow{background:linear-gradient(180deg,var(--yellow),#b37a00);color:#2b1a00}
  .led-label{font-size:13px;color:var(--muted)}
  .last-up{font-size:13px;color:var(--muted)}
  .banner{padding:10px;border-radius:8px;text-align:center;font-weight:700}
  .banner.reset{background:linear-gradient(90deg,#352e0b, #7a5d00);color:#fff}
  .banner.warn{background:linear-gradient(90deg,#311000,#6b0000);color:#fff}
  footer{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
  .small{font-size:13px;color:var(--muted)}
  .card-title{font-weight:700;margin-bottom:8px}
  .info-row{display:flex;gap:12px;align-items:center}
  .range-label{
    font-size:12px;
    color:var(--muted);
    padding:6px 8px;
    border-radius:8px;
    background:rgba(255,255,255,0.02);
  }
</style>
</head>
<body>
<header>
  <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(45deg,#008fb3,#005f8a);display:flex;align-items:center;justify-content:center;font-weight:800;color:white">I</div>
  <div>
    <h1>MONITOREO DE VARIABLES</h1>
    <div class="header-sub">MILLARES INGENIERIA BAGB SPA IOT-CHILE</div>
  </div>
</header>

<div class="container">
  <div class="main-grid">
    <div class="card">
      <div class="gauge-wrap">
        <div class="gauge-card">
          <div class="gauge" id="gauge">
            <!-- Números distribuidos en arco semicircular -->
            <div class="scale-mark">-15</div>
            <div class="scale-mark">0</div>
            <div class="scale-mark">10</div>
            <div class="scale-mark">20</div>
            <div class="scale-mark">30</div>
            <div class="scale-mark">40</div>
            <div class="scale-mark">50</div>
            <div class="scale-mark">60</div>
            <div class="scale-mark">70</div>
            <div class="scale-mark">80</div>
            <div class="scale-mark">100</div>
            
            <div class="gauge-needle" id="needle" style="--rot:0deg"></div>
            <div class="temp-display">
              <div class="temp-value" id="temp-digital">--.-</div>
              <div class="temp-unit">°C</div>
            </div>
            <div class="gauge-center-dot"></div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
          <div class="meta" id="gauge-sub">Última actualización: --</div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card status-card">
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;width:100%">
          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Estado alarma</div>
              <div id="alarma-text" class="small">No hay alarma</div>
            </div>
            <div id="led-alarma" class="led green">✓</div>
          </div>

          <div style="display:flex;gap:12px;width:100%;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column">
              <div class="card-title">Reset</div>
              <div id="reset-text" class="small">No activo</div>
            </div>
            <div id="led-reset" class="led" style="background:rgba(255,255,255,0.02);color:var(--muted)">-</div>
          </div>

          <div style="width:100%;display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <div class="last-up" id="last-up">Último ping: --</div>
            <div class="small" id="status-http">Conexión: --</div>
          </div>
        </div>
      </div>

      <div id="reset-banner" class="card banner reset" style="display:none">RESET ENVIADO</div>
      <div id="alarm-banner" class="card banner warn" style="display:none">ALARMA ACTIVADA</div>
    </div>
  </div>

  <footer>© 2025 MILLARES INGENIERIA SPA - CHILE</footer>
</div>

<script>
const THINGSPEAK_CHANNEL_ID = "3194050";
const THINGSPEAK_READ_API_KEY = "4L6L63LNFO0YG4BB";

const REFRESH_SECONDS = 30;
const TEMP_MIN = -15; const TEMP_MAX = 100;
const RANGES = [
  {to:10, color:'#003f5c'},
  {to:20, color:'#2a9df4'},
  {to:30, color:'#ffca28'},
  {to:40, color:'#ff9800'},
  {to:100, color:'#ff1744'}
];

let lastCreatedAt = null;

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch(e){return iso}
}

function setNeedleByTemp(temp){
  const min = TEMP_MIN, max = TEMP_MAX;
  let pct = (temp - min) / (max - min);
  if (pct < 0) pct = 0; if (pct > 1) pct = 1;
  const deg = -90 + (90 * pct); // Semicírculo de -90° a 90°
  document.getElementById('needle').style.setProperty('--rot', deg + 'deg');
}

function colorForTemp(temp){
  for(let r of RANGES){
    if (temp <= r.to) return r.color;
  }
  return RANGES[RANGES.length-1].color;
}

function showResetBanner(){
  const b = document.getElementById('reset-banner');
  b.style.display = 'block';
  setTimeout(()=> b.style.display = 'none', 1500);
}

function showAlarmBanner(on){
  const b = document.getElementById('alarm-banner');
  b.style.display = on ? 'block' : 'none';
}

function updateUI(feed){
  const tempRaw = feed.field1 ? parseFloat(feed.field1) : null;
  const alarma = feed.field2 ? (parseInt(feed.field2)===1) : false;
  const reset = feed.field3 ? (parseInt(feed.field3)===1) : false;
  const created_at = feed.created_at || new Date().toISOString();

  const tEl = document.getElementById('temp-digital');
  tEl.innerText = (tempRaw === null) ? '--.-' : tempRaw.toFixed(2);

  if (tempRaw !== null){
    setNeedleByTemp(tempRaw);
    tEl.style.color = '#fff';
    document.getElementById('gauge-sub').innerText = 'Última actualización: ' + fmtDate(created_at);
    lastCreatedAt = created_at;
    document.getElementById('last-up').innerText = 'Último ping: ' + fmtDate(created_at);
  }

  const ledAl = document.getElementById('led-alarma');
  const alarmaText = document.getElementById('alarma-text');
  if (alarma){
    ledAl.className = 'led red';
    ledAl.innerText = '!';
    alarmaText.innerText = '¡ALARMA ACTIVADA!';
    showAlarmBanner(true);
  } else {
    ledAl.className = 'led green';
    ledAl.innerText = '✓';
    alarmaText.innerText = 'Sin alarma';
    showAlarmBanner(false);
  }

  const ledRe = document.getElementById('led-reset');
  const resetText = document.getElementById('reset-text');
  if (reset){
    ledRe.className = 'led yellow';
    ledRe.innerText = 'R';
    resetText.innerText = 'Reset reciente';
    showResetBanner();
  } else {
    ledRe.className = 'led';
    ledRe.innerText = '-';
    resetText.innerText = 'No activo';
  }

  document.getElementById('status-http').innerText = 'Conexión: OK';
}

async function fetchLatest(){
  if (!THINGSPEAK_CHANNEL_ID || !THINGSPEAK_READ_API_KEY || THINGSPEAK_CHANNEL_ID.includes('TU_')){
    document.getElementById('gauge-sub').innerText = 'Coloca CHANNEL ID y READ API KEY en el archivo.';
    return;
  }
  try{
    const url = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL_ID}/feeds.json?results=1&api_key=${THINGSPEAK_READ_API_KEY}`;
    const resp = await fetch(url, {cache:'no-cache'});
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if (!data || !data.feeds || data.feeds.length===0) throw new Error('No data');
    updateUI(data.feeds[0]);
  }catch(err){
    console.error(err);
    document.getElementById('status-http').innerText = 'Conexión: ERROR';
    document.getElementById('gauge-sub').innerText = 'Error al leer ThingSpeak';
  }
}

fetchLatest();
setInterval(fetchLatest, REFRESH_SECONDS * 1000);

if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>







































