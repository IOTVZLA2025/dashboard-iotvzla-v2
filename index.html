
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MONITOREO VARIABLES MILLARES</title>
<link rel="icon" href="logo-millares.png" type="image/png">
<link rel="apple-touch-icon" href="logo-millares.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1622" />

<style>
  :root{
    --bg:#071427;
    --card:#0b1220;
    --accent:#00bcd4;
    --muted:#9fb3c8;
    --yellow:#ffca28;
    --orange:#ff9800;
    --danger:#ff1744;
    --ok:#00c853;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:#071427;
    color:#e9eef6;
    padding:0;
    margin:0;
    min-height:100vh;
  }

  /* HEADER SIMPLE Y FIJO */
  .header{
    background:#0b1220;
    padding:12px 15px;
    border-bottom:1px solid rgba(255,255,255,0.05);
    position:sticky;
    top:0;
    z-index:100;
  }
  .header-content{
    display:flex;
    align-items:center;
    gap:10px;
    max-width:900px;
    margin:0 auto;
  }
  .header-logo{
    width:40px;
    height:40px;
    border-radius:8px;
    object-fit:contain;
    background:rgba(255,255,255,0.05);
    padding:3px;
    border:1px solid rgba(0,188,212,0.2);
  }
  .header-text{
    flex:1;
  }
  .header-text h1{
    margin:0;
    font-size:16px;
    color:#fff;
  }
  .header-company{
    font-size:13px;
    color:#00bcd4;
    font-weight:600;
    margin-top:2px;
  }
  .header-subtitle{
    font-size:11px;
    color:#9fb3c8;
    margin-top:1px;
  }

  /* CONTENIDO PRINCIPAL */
  .container{
    max-width:900px;
    margin:0 auto;
    padding:15px;
  }

  /* TARJETA PRINCIPAL */
  .card{
    background:#0b1220;
    border-radius:12px;
    padding:20px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow:0 8px 25px rgba(2,6,23,0.5);
  }

  /* ========== GAUGE NUEVO - TOTALMENTE CORREGIDO ========== */
  .gauge-container{
    position:relative;
    width:280px;
    height:140px;
    margin:0 auto 20px auto;
  }

  /* Fondo del semicírculo */
  .gauge-base{
    position:absolute;
    width:280px;
    height:140px;
    background:#091425;
    border-radius:0 0 140px 140px;
    border:6px solid rgba(255,255,255,0.05);
    border-top:none;
    overflow:hidden;
  }

  /* Arco de colores */
  .gauge-arc{
    position:absolute;
    width:280px;
    height:140px;
    background:conic-gradient(
      from 180deg,
      #00c853 0deg,
      #ffca28 90deg,
      #ff9800 135deg,
      #ff1744 180deg
    );
    border-radius:0 0 140px 140px;
    clip-path:polygon(0% 70%, 100% 70%, 100% 100%, 0% 100%);
    opacity:0.3;
  }

  /* MARCAS - POSICIONADAS MANUALMENTE SIN ROTACIÓN */
  .gauge-marks{
    position:absolute;
    width:100%;
    height:100%;
  }

  /* Cada marca individual - posicionada con left/bottom */
  .mark{
    position:absolute;
    width:2px;
    height:12px;
    background:#fff;
    bottom:0;
    transform:translateX(-50%);
    z-index:5;
  }

  /* NÚMEROS - POSICIONADOS MANUALMENTE */
  .gauge-numbers{
    position:absolute;
    width:100%;
    height:100%;
    color:#fff;
    font-size:13px;
    font-weight:600;
    text-shadow:0 1px 3px rgba(0,0,0,0.8);
  }

  /* Cada número individual */
  .number{
    position:absolute;
    text-align:center;
    transform:translateX(-50%);
    z-index:6;
    white-space:nowrap;
  }

  /* AGUJA SIMPLE */
  .needle{
    --angle:0deg;
    position:absolute;
    width:2px;
    height:90px;
    background:linear-gradient(to top, #ffca28, #ff9800);
    border-radius:1px;
    transform-origin:50% 100%;
    left:50%;
    bottom:0;
    transform:translateX(-50%) rotate(var(--angle));
    z-index:20;
    box-shadow:0 0 6px rgba(255,202,40,0.6);
  }

  /* Centro de la aguja */
  .needle-center{
    position:absolute;
    width:14px;
    height:14px;
    background:#000;
    border:2px solid #ffca28;
    border-radius:50%;
    left:50%;
    bottom:-7px;
    transform:translateX(-50%);
    z-index:21;
    box-shadow:0 0 6px rgba(255,202,40,0.4);
  }

  /* TEMPERATURA DIGITAL */
  .temp-display{
    text-align:center;
    margin:10px 0 20px 0;
  }
  .temp-value{
    font-size:42px;
    font-weight:800;
    color:#ffca28;
    text-shadow:0 3px 10px rgba(255,202,40,0.3);
    line-height:1;
  }
  .temp-unit{
    font-size:22px;
    color:rgba(255,255,255,0.7);
    margin-left:2px;
  }

  /* INFORMACIÓN */
  .info{
    text-align:center;
    margin-bottom:20px;
  }
  .update-time{
    font-size:13px;
    color:#9fb3c8;
    margin:10px 0;
    padding:8px 15px;
    background:rgba(255,255,255,0.02);
    border-radius:8px;
    display:inline-block;
  }
  .update-note{
    font-size:12px;
    color:#9fb3c8;
  }

  /* PANEL DE ESTADOS */
  .status-panel{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
    margin:25px 0;
  }

  /* TARJETAS DE ESTADO */
  .status-card{
    background:rgba(255,255,255,0.02);
    border-radius:10px;
    padding:15px;
    text-align:center;
    border:1px solid rgba(255,255,255,0.03);
  }
  .status-title{
    font-weight:700;
    font-size:14px;
    margin-bottom:8px;
    color:#fff;
  }
  .status-text{
    font-size:12px;
    color:#9fb3c8;
    margin-bottom:12px;
    min-height:18px;
  }

  /* LEDS */
  .status-led{
    width:60px;
    height:60px;
    border-radius:10px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:16px;
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }
  .led-green{
    background:linear-gradient(180deg,#00c853,#007a2b);
    color:#021;
  }
  .led-red{
    background:linear-gradient(180deg,#ff1744,#a1002b);
    color:#250005;
  }
  .led-yellow{
    background:linear-gradient(180deg,#ffca28,#b37a00);
    color:#2b1a00;
  }
  .led-off{
    background:rgba(255,255,255,0.02);
    color:#9fb3c8;
  }

  /* INFO CONEXIÓN */
  .connection-info{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    color:#9fb3c8;
    margin-top:20px;
    padding-top:15px;
    border-top:1px solid rgba(255,255,255,0.03);
  }

  /* BANNERS */
  .alert-banner{
    padding:10px;
    border-radius:8px;
    text-align:center;
    font-weight:700;
    font-size:14px;
    margin-top:15px;
    display:none;
  }
  .alert-alarm{
    background:linear-gradient(90deg,#311000,#6b0000);
    color:#fff;
  }
  .alert-reset{
    background:linear-gradient(90deg,#352e0b,#7a5d00);
    color:#fff;
  }

  /* FOOTER */
  .footer{
    text-align:center;
    font-size:11px;
    color:#9fb3c8;
    margin-top:20px;
    padding-top:15px;
    border-top:1px solid rgba(255,255,255,0.03);
  }

  /* RESPONSIVE */
  @media(max-width:620px){
    .container{
      padding:10px;
    }
    .card{
      padding:15px;
    }
    .gauge-container{
      width:260px;
      height:130px;
    }
    .gauge-base,
    .gauge-arc{
      width:260px;
      height:130px;
      border-radius:0 0 130px 130px;
    }
    .needle{
      height:85px;
    }
    .temp-value{
      font-size:38px;
    }
    .status-panel{
      grid-template-columns:1fr;
      gap:10px;
    }
    .header-content{
      flex-direction:column;
      text-align:center;
      gap:8px;
    }
    .header-logo{
      width:36px;
      height:36px;
    }
  }
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-content">
      <img src="logo-millares.png" alt="Logo Millares" class="header-logo">
      <div class="header-text">
        <h1>MONITOREO VARIABLES</h1>
        <div class="header-company">MILLARES BAGB SPA IOT CHILE</div>
        <div class="header-subtitle">Temperatura · Alarma · Reset</div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="container">
    <div class="card">
      <!-- GAUGE NUEVO -->
      <div class="gauge-container">
        <div class="gauge-base"></div>
        <div class="gauge-arc"></div>
        <div class="gauge-marks" id="gaugeMarks"></div>
        <div class="gauge-numbers" id="gaugeNumbers"></div>
        <div class="needle" id="needle" style="--angle:0deg"></div>
        <div class="needle-center"></div>
      </div>

      <!-- TEMPERATURA DIGITAL -->
      <div class="temp-display">
        <div class="temp-value" id="tempValue">25.3<span class="temp-unit">°C</span></div>
      </div>

      <!-- INFORMACIÓN -->
      <div class="info">
        <div id="updateTime" class="update-time">Última actualización: --</div>
        <div class="update-note">Actualización automática cada 30 segundos</div>
      </div>

      <!-- PANEL DE ESTADOS -->
      <div class="status-panel">
        <div class="status-card">
          <div class="status-title">Estado alarma</div>
          <div id="alarmText" class="status-text">Normal</div>
          <div id="ledAlarm" class="status-led led-green">✓</div>
        </div>

        <div class="status-card">
          <div class="status-title">Reset sistema</div>
          <div id="resetText" class="status-text">No activo</div>
          <div id="ledReset" class="status-led led-off">-</div>
        </div>
      </div>

      <!-- BANNERS -->
      <div id="alarmBanner" class="alert-banner alert-alarm" style="display:none">ALARMA ACTIVADA</div>
      <div id="resetBanner" class="alert-banner alert-reset" style="display:none">RESET RECOMENDADO</div>

      <!-- INFO CONEXIÓN -->
      <div class="connection-info">
        <div id="lastPing">Último ping: --</div>
        <div id="connStatus">Conexión: --</div>
      </div>

      <!-- FOOTER -->
      <div class="footer">
        &copy; 2024 MILLARES BAGB SPA IOT CHILE - Sistema IoT
      </div>
    </div>
  </main>

<script>
// =============================================
// CONFIGURACIÓN
// =============================================
const CONFIG = {
  thingspeak: {
    channelId: '3194050',
    readApiKey: '4L6L63LNFO0YG4BB',
    field: 1,
    url: 'https://api.thingspeak.com/channels/'
  },
  updateInterval: 30000,
  alarmThreshold: 50,
  resetThreshold: 60
};

// =============================================
// CREAR GAUGE - POSICIÓN EXACTA DE MARCAS Y NÚMEROS
// =============================================
function initGauge() {
  const marksContainer = document.getElementById('gaugeMarks');
  const numbersContainer = document.getElementById('gaugeNumbers');
  
  // Valores a mostrar
  const values = [-15, 0, 25, 50, 75, 100];
  
  // Coordenadas del semicírculo
  const centerX = 140;  // Centro horizontal
  const bottomY = 140;  // Línea de base
  const radius = 130;   // Radio del semicírculo
  
  // Ángulos correspondientes (de -90° a 90°)
  const angles = [-90, -54, -18, 18, 54, 90]; // Distribuidos uniformemente
  
  // Crear marcas y números
  for (let i = 0; i < values.length; i++) {
    const temp = values[i];
    const angle = angles[i];
    const rad = angle * (Math.PI / 180);
    
    // Posición de la MARCA (en el borde)
    const markX = centerX + Math.cos(rad) * radius;
    const markY = bottomY - Math.sin(rad) * radius;
    
    // Crear marca
    const mark = document.createElement('div');
    mark.className = 'mark';
    mark.style.left = `${markX}px`;
    mark.style.bottom = `${markY}px`;
    marksContainer.appendChild(mark);
    
    // Posición del NÚMERO (un poco más arriba)
    const numberOffset = 22;
    const numberX = centerX + Math.cos(rad) * (radius + numberOffset);
    const numberY = bottomY - Math.sin(rad) * (radius + numberOffset);
    
    // Crear número
    const number = document.createElement('div');
    number.className = 'number';
    number.textContent = temp;
    number.style.left = `${numberX}px`;
    number.style.bottom = `${numberY}px`;
    
    // Rotar número para que siga la curva (opcional)
    if (angle < -45) {
      number.style.transform = `translateX(-50%) rotate(-30deg)`;
    } else if (angle < 0) {
      number.style.transform = `translateX(-50%) rotate(-15deg)`;
    } else if (angle < 45) {
      number.style.transform = `translateX(-50%) rotate(15deg)`;
    } else {
      number.style.transform = `translateX(-50%) rotate(30deg)`;
    }
    
    numbersContainer.appendChild(number);
  }
}

// =============================================
// OBTENER DATOS DE THINGSPEAK
// =============================================
async function fetchThingSpeakData() {
  const { channelId, readApiKey, field, url } = CONFIG.thingspeak;
  const apiUrl = `${url}${channelId}/fields/${field}/last.json?api_key=${readApiKey}`;
  
  try {
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error('Error en la respuesta');
    const data = await response.json();
    return parseFloat(data[`field${field}`]) || 0;
  } catch (error) {
    console.error('Error:', error);
    return 25.3;
  }
}

// =============================================
// ACTUALIZAR GAUGE
// =============================================
function updateGauge(temp) {
  const needle = document.getElementById('needle');
  const tempValue = document.getElementById('tempValue');
  
  // Actualizar valor digital
  tempValue.textContent = temp.toFixed(1);
  
  // Calcular ángulo (-15°C = -90°, 100°C = 90°)
  const minTemp = -15;
  const maxTemp = 100;
  const clampedTemp = Math.max(minTemp, Math.min(maxTemp, temp));
  const percent = (clampedTemp - minTemp) / (maxTemp - minTemp);
  const angle = -90 + (percent * 180);
  
  // Actualizar aguja
  needle.style.setProperty('--angle', `${angle}deg`);
  
  // Color del valor
  if (temp >= 20 && temp <= 30) {
    tempValue.style.color = '#00c853';
  } else if (temp > 30 && temp <= 50) {
    tempValue.style.color = '#ffca28';
  } else if (temp > 50 && temp <= CONFIG.alarmThreshold) {
    tempValue.style.color = '#ff9800';
  } else if (temp > CONFIG.alarmThreshold) {
    tempValue.style.color = '#ff1744';
  } else if (temp < 0) {
    tempValue.style.color = '#00bcd4';
  } else {
    tempValue.style.color = '#ffca28';
  }
  
  return temp;
}

// =============================================
// ACTUALIZAR ESTADOS
// =============================================
function updateStatus(temp) {
  const alarmLed = document.getElementById('ledAlarm');
  const alarmText = document.getElementById('alarmText');
  const resetLed = document.getElementById('ledReset');
  const resetText = document.getElementById('resetText');
  const alarmBanner = document.getElementById('alarmBanner');
  const resetBanner = document.getElementById('resetBanner');
  
  // Alarma
  if (temp > CONFIG.alarmThreshold) {
    alarmLed.className = 'status-led led-red';
    alarmLed.textContent = '!';
    alarmText.textContent = 'ALARMA';
    alarmText.style.color = '#ff1744';
    alarmBanner.style.display = 'block';
  } else if (temp > 30) {
    alarmLed.className = 'status-led led-yellow';
    alarmLed.textContent = '⚠';
    alarmText.textContent = 'ADVERTENCIA';
    alarmText.style.color = '#ffca28';
    alarmBanner.style.display = 'none';
  } else {
    alarmLed.className = 'status-led led-green';
    alarmLed.textContent = '✓';
    alarmText.textContent = 'Normal';
    alarmText.style.color = '';
    alarmBanner.style.display = 'none';
  }
  
  // Reset
  if (temp > CONFIG.resetThreshold) {
    resetLed.className = 'status-led led-red';
    resetLed.textContent = '!';
    resetText.textContent = 'RESET RECOMENDADO';
    resetText.style.color = '#ff1744';
    resetBanner.style.display = 'block';
  } else {
    resetLed.className = 'status-led led-off';
    resetLed.textContent = '-';
    resetText.textContent = 'No activo';
    resetText.style.color = '';
    resetBanner.style.display = 'none';
  }
}

// =============================================
// ACTUALIZAR TIMESTAMP
// =============================================
function updateTimestamp(success = true) {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('es-CL', { 
    hour: '2-digit', 
    minute: '2-digit',
    second: '2-digit' 
  });
  const dateStr = now.toLocaleDateString('es-CL');
  
  document.getElementById('updateTime').textContent = `Última actualización: ${dateStr} ${timeStr}`;
  document.getElementById('lastPing').textContent = `Ping: ${timeStr}`;
  
  const statusEl = document.getElementById('connStatus');
  if (success) {
    statusEl.textContent = 'Conexión: OK';
    statusEl.style.color = '#00c853';
  } else {
    statusEl.textContent = 'Conexión: ERROR';
    statusEl.style.color = '#ff1744';
  }
}

// =============================================
// FUNCIÓN PRINCIPAL
// =============================================
async function updateDashboard() {
  try {
    const temperature = await fetchThingSpeakData();
    updateGauge(temperature);
    updateStatus(temperature);
    updateTimestamp(true);
  } catch (error) {
    updateTimestamp(false);
  }
}

// =============================================
// INICIALIZAR
// =============================================
document.addEventListener('DOMContentLoaded', function() {
  initGauge();
  updateDashboard();
  setInterval(updateDashboard, CONFIG.updateInterval);
});
</script>
</body>
</html>
